<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitLab Batch Merge Request Creator</title>
    <link rel="icon" href="https://services.bonjourr.fr/favicon/blob/http://www.gitlab.com">
    <style>
        /* é˜²æ­¢é¡µé¢åŠ è½½é—ªçƒ - å…³é”®CSSä¼˜å…ˆåŠ è½½ */
        html {
            background: #0b1220;
        }

        body {
            margin: 0;
            padding: 0;
            background: #0b1220;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        body.loaded {
            opacity: 1;
        }

        :root {
            /* æ·±è‰²ä¸»é¢˜é¢œè‰²ç³»ç»Ÿ */
            --bg: #0b1220;
            --panel: #111a2e;
            --border: rgba(255, 255, 255, 0.08);
            --text: #e6edf3;
            --muted: rgba(230, 237, 243, 0.7);
            --primary: rgba(99, 102, 241, 0.55);
            --primary-bg: rgba(99, 102, 241, 0.18);
            --primary-hover: rgba(99, 102, 241, 0.28);
            --radius: 14px;
            --shadow: 0 18px 48px rgba(0, 0, 0, 0.55);

            /* çŠ¶æ€è‰²ç³»ç»Ÿ */
            --success-bg: rgba(34, 197, 94, 0.2);
            --success-text: #22c55e;
            --info-bg: rgba(59, 130, 246, 0.2);
            --info-text: #3b82f6;
            --warning-bg: rgba(234, 179, 8, 0.2);
            --warning-text: #eab308;
            --danger-bg: rgba(239, 68, 68, 0.2);
            --danger-text: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            padding: 8px;
            overflow: hidden;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            transition: background 0.2s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Firefoxæ»šåŠ¨æ¡æ ·å¼ */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.15) rgba(255, 255, 255, 0.02);
        }

        .container {
            max-width: 100%;
            height: 100%;
            margin: 0 auto;
            background: var(--panel);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: rgba(99, 102, 241, 0.15);
            border-bottom: 1px solid var(--border);
            color: var(--text);
            padding: 8px 15px;
            text-align: center;
            flex-shrink: 0;
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
        }

        .header h1 {
            font-size: 1.2em;
            font-weight: 400;
            margin: 0;
            flex-shrink: 0;
            line-height: 1.4;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.75em;
            margin: 0;
            flex-shrink: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.4;
        }

        @media (max-width: 1200px) {
            .header p {
                display: none;
            }
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 370px 400px 1fr 1fr;
            gap: 10px;
            padding: 10px;
            overflow: hidden;
        }

        @media (max-width: 1600px) {
            .main-content {
                grid-template-columns: 340px 380px 1fr 1fr;
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 320px 1fr;
            }
            .display-panel {
                display: none !important;
            }
        }

        /* å·¦ä¾§æ  */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        /* å³ä¾§æ  */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        /* å±•ç¤ºé¢æ¿ */
        .display-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
            min-height: 0;
        }

        .section {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .section-title {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .section-title::before {
            content: '';
            width: 2px;
            height: 10px;
            background: var(--primary);
            border-radius: 2px;
        }

        .section-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .search-container {
            position: relative;
            margin-bottom: 6px;
        }

        .search-input {
            width: 100%;
            padding: 6px 30px 6px 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .search-input::placeholder {
            color: var(--muted);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        /* é¡¹ç›®é€‰æ‹©å™¨æ ·å¼ */
        .project-selector {
            max-height: none;
            height: 100%;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.02);
        }

        /* åˆ†ç»„æ ‡é¢˜æ ·å¼ */
        .group-header {
            padding: 8px 12px 6px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 12px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .group-header:hover {
            background: rgba(99, 102, 241, 0.25);
        }

        .group-toggle {
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .group-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .group-stats {
            margin-left: auto;
            font-size: 12px;
            background: var(--primary-bg);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .group-content {
            display: block;
        }

        .group-content.collapsed {
            display: none;
        }

        .project-item {
            padding: 6px 12px 6px 24px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .project-item:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .project-item.selected {
            background: var(--primary-bg);
            border-left: 4px solid var(--primary);
        }

        .project-checkbox {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .project-name {
            flex: 1;
            font-weight: 500;
            font-size: 12px;
        }

        .project-name .highlight {
            background: var(--warning-bg);
            color: var(--warning-text);
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* å·²é€‰æ‹©é¡¹ç›®æ ‡ç­¾æ ·å¼ */
        .selected-tags-container {
            margin-top: 8px;
            margin-bottom: 8px;
            display: none;
        }

        .selected-tags-container.show {
            display: block;
        }

        .selected-tags-title {
            font-weight: 600;
            font-size: 11px;
            color: var(--text);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-height: 80px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .selected-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--primary-bg);
            color: var(--text);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease;
            border: 1px solid var(--primary);
        }

        .selected-tag:hover {
            background: var(--primary-hover);
        }

        .selected-tag .remove-icon {
            width: 14px;
            height: 14px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .selected-tag .remove-icon:hover {
            background: rgba(255,255,255,0.5);
        }

        /* ====== è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†ç»„ä»¶ - ä¸“ä¸šUI/UXè®¾è®¡ ====== */

        /* ä¸‹æ‹‰æ¡†å®¹å™¨ */
        .custom-select-wrapper {
            position: relative;
            width: 100%;
        }

        /* ä¸‹æ‹‰æ¡†è§¦å‘å™¨ - ç»ç’ƒæ€æ•ˆæœ */
        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            background: linear-gradient(
                135deg,
                rgba(17, 26, 46, 0.95) 0%,
                rgba(11, 18, 32, 0.98) 100%
            );
            backdrop-filter: blur(12px);
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
            user-select: none;
            min-height: 36px;
        }

        /* æ‚¬åœæ•ˆæœ */
        .custom-select-trigger:hover {
            border-color: rgba(99, 102, 241, 0.6);
            background: linear-gradient(
                135deg,
                rgba(17, 26, 46, 1) 0%,
                rgba(11, 18, 32, 1) 100%
            );
            box-shadow:
                0 4px 16px rgba(99, 102, 241, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.12);
            transform: translateY(-1px);
        }

        /* æ¿€æ´»çŠ¶æ€ */
        .custom-select-trigger.active {
            border-color: var(--primary);
            background: linear-gradient(
                135deg,
                rgba(99, 102, 241, 0.12) 0%,
                rgba(99, 102, 241, 0.08) 100%
            );
            box-shadow:
                0 0 0 3px rgba(99, 102, 241, 0.2),
                0 6px 20px rgba(99, 102, 241, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        /* é€‰ä¸­çš„å€¼ */
        .custom-select-value {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
            line-height: 1.4;
        }

        /* å ä½ç¬¦æ ·å¼ */
        .custom-select-value.placeholder {
            color: var(--muted);
            font-weight: 400;
        }

        /* ç®­å¤´å›¾æ ‡ */
        .custom-select-arrow {
            width: 16px;
            height: 16px;
            margin-left: 8px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        .custom-select-trigger.active .custom-select-arrow {
            transform: rotate(180deg);
        }

        /* ä¸‹æ‹‰é€‰é¡¹é¢æ¿ */
        .custom-select-dropdown {
            position: fixed;
            max-height: 280px;
            overflow-y: auto;
            background: linear-gradient(
                180deg,
                rgba(17, 26, 46, 0.98) 0%,
                rgba(11, 18, 32, 0.98) 100%
            );
            backdrop-filter: blur(16px);
            border: 1px solid rgba(99, 102, 241, 0.4);
            border-radius: 12px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(99, 102, 241, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            min-width: 200px;
        }

        /* ä¸‹æ‹‰é¢æ¿æ˜¾ç¤ºçŠ¶æ€ */
        .custom-select-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* é€‰é¡¹é¡¹ */
        .custom-select-option {
            padding: 10px 14px 10px 14px;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: block;
            line-height: 1.5;
            word-break: break-word;
            white-space: normal;
            min-height: 38px;
            position: relative;
        }

        .custom-select-option:last-child {
            border-bottom: none;
        }

        /* é€‰é¡¹æ‚¬åœæ•ˆæœ */
        .custom-select-option:hover {
            background: linear-gradient(
                90deg,
                rgba(99, 102, 241, 0.15) 0%,
                rgba(99, 102, 241, 0.08) 100%
            );
            padding-left: 18px;
        }

        /* é€‰ä¸­çš„é€‰é¡¹ */
        .custom-select-option.selected {
            background: linear-gradient(
                90deg,
                rgba(99, 102, 241, 0.25) 0%,
                rgba(99, 102, 241, 0.15) 100%
            );
            color: #ffffff;
            font-weight: 600;
            border-left: 3px solid var(--primary);
            padding-left: 15px;
            padding-right: 32px;
        }

        .custom-select-option.selected::after {
            content: 'âœ“';
            font-size: 14px;
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* ç¦ç”¨çŠ¶æ€ */
        .custom-select-trigger.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* æœç´¢æ¡†ï¼ˆå¯é€‰ï¼‰ */
        .custom-select-search {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: rgba(17, 26, 46, 0.98);
            backdrop-filter: blur(16px);
            z-index: 1;
        }

        .custom-select-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            font-size: 13px;
            outline: none;
            transition: all 0.2s ease;
        }

        .custom-select-search input:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
        }

        /* ç©ºçŠ¶æ€ */
        .custom-select-empty {
            padding: 24px 16px;
            text-align: center;
            color: var(--muted);
            font-size: 13px;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .custom-select-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .custom-select-dropdown::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 3px;
        }

        .custom-select-dropdown::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.4);
            border-radius: 3px;
            transition: background 0.2s;
        }

        .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.6);
        }
        .branch-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .branch-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .branch-label {
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* ä¸‹æ‹‰æ¡†ä¸»ä½“ - æ¸å˜èƒŒæ™¯ + ç»ç’ƒæ€æ•ˆæœ */
        .branch-select {
            padding: 10px 36px 10px 14px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.08) 0%,
                rgba(255, 255, 255, 0.04) 100%
            );
            backdrop-filter: blur(10px);
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            position: relative;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='%23e6edf3' d='M4.427 6.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 6H4.604a.25.25 0 00-.177.427z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            /* å¼ºåˆ¶æ·±è‰²æ¨¡å¼ */
            color-scheme: dark;
        }

        /* æ‚¬åœæ•ˆæœ - å‘å…‰è¾¹æ¡† */
        .branch-select:hover {
            border-color: rgba(99, 102, 241, 0.6);
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.12) 0%,
                rgba(255, 255, 255, 0.06) 100%
            );
            box-shadow:
                0 4px 12px rgba(99, 102, 241, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        /* èšç„¦æ•ˆæœ - ä¸»è‰²è°ƒå…‰æ™• */
        .branch-select:focus {
            outline: none;
            border-color: var(--primary);
            background: linear-gradient(
                135deg,
                rgba(99, 102, 241, 0.15) 0%,
                rgba(99, 102, 241, 0.08) 100%
            );
            box-shadow:
                0 0 0 4px rgba(99, 102, 241, 0.2),
                0 6px 16px rgba(99, 102, 241, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* æ¿€æ´»çŠ¶æ€ */
        .branch-select:active {
            transform: translateY(0);
            box-shadow:
                0 0 0 4px rgba(99, 102, 241, 0.15),
                0 2px 8px rgba(99, 102, 241, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        /* ä¸‹æ‹‰é€‰é¡¹æ ·å¼ - æ·±è‰²ä¸»é¢˜ä¼˜åŒ– */
        .branch-select option {
            background: #111a2e !important;
            color: var(--text) !important;
            font-weight: 500;
            padding: 10px 14px;
        }

        /* é€‰é¡¹æ‚¬åœæ•ˆæœ */
        .branch-select option:hover {
            background: rgba(99, 102, 241, 0.25) !important;
            color: var(--text) !important;
        }

        /* é€‰ä¸­çš„é€‰é¡¹ */
        .branch-select option:checked,
        .branch-select option:checked:hover {
            background: rgba(99, 102, 241, 0.4) !important;
            color: #ffffff !important;
            font-weight: 600;
        }

        /* Firefox ç‰¹æ®Šå¤„ç† */
        @-moz-document url-prefix() {
            .branch-select {
                color-scheme: dark;
            }
            .branch-select option {
                background-color: #111a2e;
                color: #e6edf3;
            }
        }

        /* Webkit æµè§ˆå™¨ï¼ˆChrome/Edge/Safariï¼‰ç‰¹æ®Šå¤„ç† */
        @supports (-webkit-appearance: none) {
            .branch-select {
                color-scheme: dark;
            }
        }

        /* ç¦ç”¨çŠ¶æ€ */
        .branch-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.02);
            box-shadow: none;
        }

        .branch-select:disabled:hover {
            transform: none;
        }

        /* æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .control-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.15s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .btn-primary {
            background: var(--primary-bg);
            border-color: var(--primary);
            color: var(--text);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: rgba(156, 163, 175, 0.15);
            border-color: rgba(156, 163, 175, 0.3);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: rgba(156, 163, 175, 0.25);
        }

        .btn-success {
            background: var(--success-bg);
            border-color: var(--success-text);
            color: var(--success-text);
        }

        .btn-success:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* è¡¨å•æ ·å¼ */
        .form-row {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .form-label {
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
        }

        .form-input {
            padding: 8px 12px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.08) 0%,
                rgba(255, 255, 255, 0.04) 100%
            );
            backdrop-filter: blur(10px);
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            line-height: 1.4;
            min-height: 36px;
        }

        .form-input:hover {
            border-color: rgba(99, 102, 241, 0.6);
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.12) 0%,
                rgba(255, 255, 255, 0.06) 100%
            );
            box-shadow:
                0 4px 12px rgba(99, 102, 241, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: linear-gradient(
                135deg,
                rgba(99, 102, 241, 0.15) 0%,
                rgba(99, 102, 241, 0.08) 100%
            );
            box-shadow:
                0 0 0 4px rgba(99, 102, 241, 0.2),
                0 6px 16px rgba(99, 102, 241, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .form-input::placeholder {
            color: var(--muted);
            font-weight: 400;
        }

        /* textarea ç‰¹æ®Šæ ·å¼ */
        textarea.form-input {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        /* select ä¸‹æ‹‰æ¡†ç‰¹æ®Šæ ·å¼ */
        select.form-input {
            padding-right: 36px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='%23e6edf3' d='M4.427 6.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 6H4.604a.25.25 0 00-.177.427z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            /* å¼ºåˆ¶æ·±è‰²æ¨¡å¼ */
            color-scheme: dark;
        }

        /* select ä¸‹æ‹‰é€‰é¡¹æ ·å¼ */
        select.form-input option {
            background: #111a2e !important;
            color: var(--text) !important;
            font-weight: 500;
            padding: 10px 14px;
        }

        select.form-input option:hover {
            background: rgba(99, 102, 241, 0.25) !important;
            color: var(--text) !important;
        }

        select.form-input option:checked,
        select.form-input option:checked:hover {
            background: rgba(99, 102, 241, 0.4) !important;
            color: #ffffff !important;
            font-weight: 600;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            margin: 8px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 6px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
        }

        /* ç»“æœè¡¨æ ¼æ ·å¼ */
        .results-table {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 13px;
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        .results-table thead {
            display: block;
            width: 100%;
            flex-shrink: 0;
            background: var(--primary-bg);
            box-sizing: border-box;
            overflow-y: scroll;
            overflow-x: hidden;
        }

        .results-table thead tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .results-table tbody {
            display: block;
            flex: 1;
            overflow-y: scroll;
            overflow-x: hidden;
            width: 100%;
            min-height: 0;
        }

        .results-table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .results-table th {
            background: var(--primary-bg);
            color: var(--text);
            padding: 6px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
        }

        .results-table td {
            padding: 5px 8px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .results-table th:nth-child(1),
        .results-table td:nth-child(1) {
            width: 25%;
        }

        .results-table th:nth-child(2),
        .results-table td:nth-child(2) {
            width: 12%;
        }

        .results-table th:nth-child(3),
        .results-table td:nth-child(3) {
            width: 12%;
        }

        .results-table th:nth-child(4),
        .results-table td:nth-child(4) {
            width: 18%;
        }

        .results-table th:nth-child(5),
        .results-table td:nth-child(5) {
            width: 33%;
        }

        .results-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-success {
            color: var(--success-text);
            font-weight: 600;
        }

        .status-error {
            color: var(--danger-text);
            font-weight: 600;
        }

        .status-pending {
            color: var(--warning-text);
            font-weight: 600;
        }

        /* æäº¤è¡¨æ ¼æ ·å¼ */
        .commits-table {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 13px;
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        .commits-table thead {
            display: block;
            width: 100%;
            flex-shrink: 0;
            background: rgba(102, 126, 234, 0.2);
            box-sizing: border-box;
            overflow-y: scroll;
            overflow-x: hidden;
        }

        .commits-table thead tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .commits-table tbody {
            display: block;
            flex: 1;
            overflow-y: scroll;
            overflow-x: hidden;
            width: 100%;
            min-height: 0;
        }

        .commits-table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .commits-table th {
            background: rgba(102, 126, 234, 0.2);
            color: var(--text);
            padding: 6px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
        }

        .commits-table td {
            padding: 5px 8px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .commits-table th:nth-child(1),
        .commits-table td:nth-child(1) {
            width: 20%;
        }

        .commits-table th:nth-child(2),
        .commits-table td:nth-child(2) {
            width: 12%;
        }

        .commits-table th:nth-child(3),
        .commits-table td:nth-child(3) {
            width: 35%;
        }

        .commits-table th:nth-child(4),
        .commits-table td:nth-child(4) {
            width: 15%;
        }

        .commits-table th:nth-child(5),
        .commits-table td:nth-child(5) {
            width: 18%;
        }

        .commits-table tr:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .commit-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .commit-link:hover {
            text-decoration: underline;
        }

        /* Result table link style - high contrast for dark background */
        .results-table a {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }

        .results-table a:hover {
            color: #93c5fd;
            text-decoration: underline;
        }

        /* æç¤ºæ¶ˆæ¯æ ·å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: var(--text);
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background: var(--success-bg);
            border-color: var(--success-text);
        }

        .toast-error {
            background: var(--danger-bg);
            border-color: var(--danger-text);
        }

        .toast-warning {
            background: var(--warning-bg);
            border-color: var(--warning-text);
        }

        /* é…ç½®é¢æ¿æ ·å¼ */
        .config-panel {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px;
            margin-bottom: 8px;
        }

        .config-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
        }

        .config-content {
            display: none;
        }

        .config-content.show {
            display: block;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }

            .main-content {
                padding: 20px;
            }

            .branch-container {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .control-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* ç»Ÿè®¡ä¿¡æ¯æ ·å¼ */
        .stats-container {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.04);
            padding: 6px 10px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
            flex: 1;
            min-width: 70px;
        }

        .stat-number {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸš€ GitLab Batch MR Creator</h1>
        <p>é«˜æ•ˆåˆ›å»ºå¤šé¡¹ç›®åˆå¹¶è¯·æ±‚å·¥å…·</p>
    </div>

    <div class="main-content">
        <!-- ç¬¬ä¸€æ ï¼šé¡¹ç›®é€‰æ‹© -->
        <div class="left-panel">
            <!-- é…ç½®é¢æ¿ -->
            <div class="config-panel">
                <div class="config-toggle" onclick="toggleConfig()">
                    âš™ï¸ é…ç½® <span id="configArrow">â–¼</span>
                </div>
                <div class="config-content" id="configContent">
                    <!-- éšç§è¯´æ˜ -->
                    <div style="font-size: 11px; color: var(--muted); margin-bottom: 12px; padding: 6px; background: rgba(34, 197, 94, 0.1); border-radius: 6px; border: 1px solid rgba(34, 197, 94, 0.3);">
                        ğŸ”’ <strong style="color: var(--success-text);">éšç§ä¿æŠ¤</strong>ï¼šæ‰€æœ‰é…ç½®æ•°æ®ï¼ˆGitLabã€AIï¼‰ä»…ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨
                    </div>

                    <!-- GitLab é…ç½® -->
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 600; font-size: 12px; color: var(--text); margin-bottom: 6px;">
                            ğŸ¦Š GitLab é…ç½®
                        </div>
                        <div class="form-row">
                            <label class="form-label">æœåŠ¡å™¨:</label>
                            <input type="text" class="form-input" id="gitlabServer" value="https://gitlab-pay.xgd.com">
                        </div>
                        <div class="form-row">
                            <label class="form-label">Token:</label>
                            <input type="password" class="form-input" id="gitlabToken" value="">
                        </div>
                        <div class="control-buttons">
                            <button class="btn btn-secondary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜</button>
                            <button class="btn btn-secondary" onclick="testConnection()">ğŸ” æµ‹è¯•</button>
                        </div>
                    </div>

                    <!-- AI é…ç½® -->
                    <div style="border-top: 1px solid var(--border); padding-top: 12px;">
                        <div style="font-weight: 600; font-size: 12px; color: var(--text); margin-bottom: 6px;">
                            ğŸ¤– AI é…ç½® (OpenAI æ ¼å¼)
                        </div>
                        <div class="form-row">
                            <label class="form-label">APIåœ°å€:</label>
                            <input type="text" class="form-input" id="aiEndpoint" placeholder="https://api.openai.com/v1">
                        </div>
                        <div class="form-row">
                            <label class="form-label">API Key:</label>
                            <input type="password" class="form-input" id="aiApiKey" placeholder="sk-...">
                        </div>
                        <div class="form-row">
                            <label class="form-label">æ¨¡å‹:</label>
                            <input type="text" class="form-input" id="aiModel" placeholder="gpt-4o-mini">
                        </div>
                        <div class="control-buttons">
                            <button class="btn btn-secondary" onclick="saveAiConfig()">ğŸ’¾ ä¿å­˜ AI é…ç½®</button>
                            <button class="btn btn-secondary" onclick="testAiConnection()">ğŸ” æµ‹è¯• AI</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-number" id="totalProjects">0</div>
                    <div class="stat-label">æ€»é¡¹ç›®</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="selectedProjects">0</div>
                    <div class="stat-label">å·²é€‰æ‹©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="commonBranches">0</div>
                    <div class="stat-label">å…±åŒåˆ†æ”¯</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCommits">0</div>
                    <div class="stat-label">å·®å¼‚æäº¤</div>
                </div>
            </div>

            <!-- é¡¹ç›®é€‰æ‹©åŒºåŸŸ -->
            <div class="section" style="flex: 1;">
                <div class="section-title">ğŸ“‚ é¡¹ç›®é€‰æ‹©</div>
                <div class="section-content">
                    <div class="search-container">
                        <input type="text" class="search-input" id="projectSearch" placeholder="ğŸ” æœç´¢é¡¹ç›®...">
                        <span class="search-icon">ğŸ”</span>
                    </div>
                    <div class="control-buttons">
                        <button class="btn btn-secondary" onclick="selectAll()">âœ… å…¨é€‰</button>
                        <button class="btn btn-secondary" onclick="selectNone()">âŒ æ¸…ç©º</button>
                        <button class="btn btn-primary" onclick="loadProjects(true)" id="refreshBtn">
                            <span class="loading hidden" id="refreshLoading"></span>
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <div class="project-selector" id="projectSelector" style="flex: 1;">
                        <div style="padding: 40px; text-align: center; color: #999;">
                            <div class="loading" style="margin: 0 auto 15px;"></div>
                            æ­£åœ¨åŠ è½½é¡¹ç›®åˆ—è¡¨...
                        </div>
                    </div>

                    <!-- å·²é€‰æ‹©é¡¹ç›®æ ‡ç­¾ -->
                    <div class="selected-tags-container" id="selectedTagsContainer">
                        <div class="selected-tags-title">
                            ğŸ·ï¸ å·²é€‰ (<span id="selectedTagsCount">0</span>)
                            <button class="btn btn-secondary" onclick="clearSelectedTags()" style="margin-left: auto; padding: 3px 6px; font-size: 10px;">æ¸…ç©º</button>
                        </div>
                        <div class="selected-tags" id="selectedTags"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬¬äºŒæ ï¼šé…ç½®å’Œæ“ä½œ -->
        <div class="right-panel">
            <!-- åˆ†æ”¯é€‰æ‹©åŒºåŸŸ -->
            <div class="section">
                <div class="section-title">ğŸŒ¿ åˆ†æ”¯é…ç½®</div>
                <div class="branch-container">
                    <div class="branch-group">
                        <label class="branch-label">ğŸ“¤ æºåˆ†æ”¯</label>
                        <select class="branch-select" id="sourceBranch">
                            <option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®</option>
                        </select>
                    </div>
                    <div class="branch-group">
                        <label class="branch-label">ğŸ“¥ ç›®æ ‡åˆ†æ”¯</label>
                        <select class="branch-select" id="targetBranch">
                            <option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®</option>
                        </select>
                    </div>
                </div>
                <!-- å¿«é€Ÿé€‰æ‹©æŒ‰é’® -->
                <div class="control-buttons" style="margin-top: 8px;">
                    <button class="btn btn-secondary" onclick="quickSelectBranch('dev', 'test')" style="font-size: 12px; padding: 6px 10px;">
                        dev â†’ test
                    </button>
                    <button class="btn btn-secondary" onclick="quickSelectBranch('test', 'uat')" style="font-size: 12px; padding: 6px 10px;">
                        test â†’ uat
                    </button>
                    <button class="btn btn-secondary" onclick="quickSelectBranch('uat', 'master')" style="font-size: 12px; padding: 6px 10px;">
                        uat â†’ master
                    </button>
                </div>
            </div>

            <!-- MRé…ç½®åŒºåŸŸ -->
            <div class="section">
                <div class="section-title">ğŸ“ MRé…ç½®</div>
                <div id="manualMrConfig">
                    <div class="form-row">
                        <label class="form-label">æ ‡é¢˜:</label>
                        <input type="text" class="form-input" id="titleTemplate" placeholder="{source} â†’ {target}">
                    </div>
                    <div class="form-row">
                        <label class="form-label">æŒ‡æ´¾:</label>
                        <select class="form-input" id="assigneeSelect">
                            <option value="">æ— </option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">æè¿°:</label>
                        <textarea class="form-input" id="descriptionTemplate" rows="2" placeholder="MRæè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                </div>

                <!-- AI æ¨¡å¼æç¤º -->
                <div id="aiModeHint" style="display: none; padding: 12px; background: rgba(99, 102, 241, 0.15); border-radius: 8px; border: 1px solid var(--primary); text-align: center; margin-bottom: 12px;">
                    <div style="font-size: 13px; color: var(--text); margin-bottom: 4px;">
                        ğŸ¤– <strong>AI ç”Ÿæˆæ¨¡å¼</strong>
                    </div>
                    <div style="font-size: 11px; color: var(--muted);">
                        å·²ä½¿ç”¨ AI ç”Ÿæˆçš„æ ‡é¢˜å’Œæè¿°ï¼Œä»…ä¿ç•™æŒ‡æ´¾äººå‘˜é…ç½®
                    </div>
                    <div style="margin-top: 8px;">
                        <button class="btn btn-secondary" onclick="clearAiMode()" style="font-size: 11px; padding: 4px 8px;">
                            âŒ æ¸…é™¤ AI ä¿¡æ¯
                        </button>
                    </div>
                </div>

                <!-- æŒ‡æ´¾äººå‘˜ï¼ˆAI æ¨¡å¼ä¸‹ä¹Ÿæ˜¾ç¤ºï¼‰ -->
                <div id="assigneeConfig" style="display: none;">
                    <div class="form-row">
                        <label class="form-label">æŒ‡æ´¾:</label>
                        <select class="form-input" id="assigneeSelectAi">
                            <option value="">æ— </option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="section">
                <div class="section-title">ğŸš€ æ‰§è¡Œæ“ä½œ</div>
                <div class="control-buttons">
                    <!-- AI ç”ŸæˆæŒ‰é’®ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼Œæœªé…ç½®æ—¶ç¦ç”¨ï¼‰ -->
                    <button class="btn btn-primary" onclick="generateMRWithAI()" id="aiGenerateBtn" disabled>
                        ğŸ¤– AI ç”ŸæˆMRä¿¡æ¯
                    </button>
                    <button class="btn btn-primary" onclick="previewCommits()" id="previewBtn" disabled>
                        ğŸ‘ï¸ é¢„è§ˆå·®å¼‚
                    </button>
                    <button class="btn btn-success" onclick="createBatchMR()" id="createBtn" disabled>
                        ğŸš€ åˆ›å»º MR
                    </button>
                </div>

                <!-- è¿›åº¦æ¡ -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰æ ï¼šæäº¤å·®å¼‚å±•ç¤º -->
        <div class="display-panel">
            <div class="section" style="height: 100%; display: flex; flex-direction: column;">
                <div class="section-title">ğŸ“Š æäº¤å·®å¼‚</div>
                <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                    <table class="commits-table" id="commitsTable">
                        <thead>
                        <tr>
                            <th style="width: 20%;">é¡¹ç›®</th>
                            <th style="width: 12%;">æäº¤ID</th>
                            <th style="width: 35%;">æ¶ˆæ¯</th>
                            <th style="width: 15%;">ä½œè€…</th>
                            <th style="width: 18%;">æ—¥æœŸ</th>
                        </tr>
                        </thead>
                        <tbody id="commitsTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--muted);">
                                ç‚¹å‡»"é¢„è§ˆå·®å¼‚"æŸ¥çœ‹æäº¤ä¿¡æ¯
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AI ç”Ÿæˆçš„ MR ä¿¡æ¯å±•ç¤ºåŒºåŸŸ -->
            <div class="section" id="aiMrInfoSection" style="display: none; margin-top: 10px; max-height: 300px; overflow-y: auto;">
                <div class="section-title">ğŸ¤– AI ç”Ÿæˆçš„ MR ä¿¡æ¯</div>
                <div id="aiMrInfoContainer" style="font-size: 12px;">
                    <!-- AI ç”Ÿæˆçš„å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>

        <!-- ç¬¬å››æ ï¼šç»“æœå±•ç¤º -->
        <div class="display-panel">
            <div class="section" style="height: 100%; display: flex; flex-direction: column;">
                <div class="section-title">âœ… åˆ›å»ºç»“æœ</div>
                <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                    <table class="results-table" id="resultsTable">
                        <thead>
                        <tr>
                            <th style="width: 25%;">é¡¹ç›®</th>
                            <th style="width: 12%;">çŠ¶æ€</th>
                            <th style="width: 12%;">MR ID</th>
                            <th style="width: 18%;">é“¾æ¥</th>
                            <th style="width: 33%;">é”™è¯¯ä¿¡æ¯</th>
                        </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--muted);">
                                ç‚¹å‡»"åˆ›å»º MR"æŸ¥çœ‹åˆ›å»ºç»“æœ
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ====== å…¨å±€å˜é‡ ======
    let allProjects = [];
    let selectedProjects = new Set();
    let availableBranches = new Map();
    let gitlabConfig = {
        server: 'https://gitlab-pay.xgd.com',
        token: ''
    };
    let aiConfig = {
        endpoint: '',
        apiKey: '',
        model: 'gpt-4o-mini'
    };
    let aiGeneratedMRInfo = new Map(); // å­˜å‚¨ AI ç”Ÿæˆçš„ MR ä¿¡æ¯ï¼Œkey: projectId, value: {title, description}
    let searchHistory = [];
    let favoriteProjects = new Set();
    let collapsedGroups = new Set(); // å­˜å‚¨æŠ˜å çš„åˆ†ç»„

    // ====== é…ç½®ç®¡ç† ======
    function loadConfig() {
        const saved = localStorage.getItem('gitlab-config');
        if (saved) {
            gitlabConfig = { ...gitlabConfig, ...JSON.parse(saved) };
            document.getElementById('gitlabServer').value = gitlabConfig.server;
            document.getElementById('gitlabToken').value = gitlabConfig.token;
        }

        // åŠ è½½ AI é…ç½®
        const savedAi = localStorage.getItem('ai-config');
        if (savedAi) {
            aiConfig = { ...aiConfig, ...JSON.parse(savedAi) };
            document.getElementById('aiEndpoint').value = aiConfig.endpoint || '';
            document.getElementById('aiApiKey').value = aiConfig.apiKey || '';
            document.getElementById('aiModel').value = aiConfig.model || 'gpt-4o-mini';
        }

        // æ›´æ–° AI æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        updateAiButtonVisibility();

        // åŠ è½½æœç´¢å†å²
        const history = localStorage.getItem('search-history');
        if (history) {
            searchHistory = JSON.parse(history);
        }

        // åŠ è½½æ”¶è—é¡¹ç›®
        const favorites = localStorage.getItem('favorite-projects');
        if (favorites) {
            favoriteProjects = new Set(JSON.parse(favorites));
        }
    }

    // æ£€æŸ¥ AI æ˜¯å¦å·²é…ç½®
    function isAiConfigured() {
        return aiConfig.endpoint && aiConfig.apiKey && aiConfig.model;
    }

    // æ›´æ–° AI æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
    function updateAiButtonVisibility() {
        // ä¸å†æ§åˆ¶æ˜¾ç¤ºéšè—ï¼ŒAI æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º
        // åªåœ¨ updateButtonStates() ä¸­æ§åˆ¶å¯ç”¨/ç¦ç”¨çŠ¶æ€
    }

    // åŒæ­¥è¾“å…¥æ¡†çš„å€¼åˆ°å†…å­˜é…ç½®ï¼ˆç”¨äºå®æ—¶ç”Ÿæ•ˆï¼‰
    function syncConfigFromInputs() {
        const server = document.getElementById('gitlabServer').value.trim();
        const token = document.getElementById('gitlabToken').value.trim();

        // åªæœ‰å½“è¾“å…¥æ¡†æœ‰å€¼æ—¶æ‰æ›´æ–°
        if (server) gitlabConfig.server = server;
        if (token) gitlabConfig.token = token;
    }

    // è·å–å½“å‰é…ç½®çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºç¼“å­˜é”®
    function getConfigHash() {
        if (!gitlabConfig.server || !gitlabConfig.token) {
            return 'default';
        }
        return btoa(gitlabConfig.server + '|' + gitlabConfig.token.substring(0, 8)).substring(0, 16);
    }

    // è°ƒè¯•å‡½æ•°ï¼šæ˜¾ç¤ºå½“å‰ç¼“å­˜çŠ¶æ€ï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼‰
    function debugCacheInfo() {
        const configHash = getConfigHash();
        const projectCacheKey = `gitlab-projects-${configHash}`;
        const projectCacheTimeKey = `gitlab-projects-time-${configHash}`;

        console.group('ğŸ” ç¼“å­˜è°ƒè¯•ä¿¡æ¯');
        console.log('å½“å‰é…ç½®Hash:', configHash);
        console.log('å½“å‰æœåŠ¡å™¨:', gitlabConfig.server);
        console.log('å½“å‰Tokenå‰ç¼€:', gitlabConfig.token.substring(0, 8) + '...');
        console.log('é¡¹ç›®ç¼“å­˜é”®:', projectCacheKey);
        console.log('é¡¹ç›®ç¼“å­˜å­˜åœ¨:', !!localStorage.getItem(projectCacheKey));

        // æ˜¾ç¤ºåˆ†æ”¯ç¼“å­˜ä¿¡æ¯
        let branchCacheCount = 0;
        for (let i = 0; i < sessionStorage.length; i++) {
            const key = sessionStorage.key(i);
            if (key && key.startsWith(`all-branches-${configHash}-`)) {
                branchCacheCount++;
            }
        }
        console.log('åˆ†æ”¯ç¼“å­˜æ•°é‡:', branchCacheCount);
        console.groupEnd();
    }

    // æ·»åŠ åˆ°windowå¯¹è±¡ï¼Œæ–¹ä¾¿æ§åˆ¶å°è°ƒç”¨
    window.debugCacheInfo = debugCacheInfo;

    function saveConfig() {
        const server = document.getElementById('gitlabServer').value.trim();
        const token = document.getElementById('gitlabToken').value.trim();

        if (!server || !token) {
            showToast('è¯·å¡«å†™å®Œæ•´çš„æœåŠ¡å™¨åœ°å€å’ŒToken', 'warning');
            return false;
        }

        gitlabConfig.server = server;
        gitlabConfig.token = token;

        try {
            localStorage.setItem('gitlab-config', JSON.stringify(gitlabConfig));
            showToast('âœ… é…ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨', 'success');
            console.log('é…ç½®ä¿å­˜æˆåŠŸ:', gitlabConfig);
            return true;
        } catch (error) {
            showToast('âŒ é…ç½®ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            console.error('é…ç½®ä¿å­˜å¤±è´¥:', error);
            return false;
        }
    }

    function toggleConfig() {
        const content = document.getElementById('configContent');
        const arrow = document.getElementById('configArrow');
        content.classList.toggle('show');
        arrow.textContent = content.classList.contains('show') ? 'â–²' : 'â–¼';
    }

    async function testConnection() {
        try {
            // å…ˆè‡ªåŠ¨ä¿å­˜å½“å‰é…ç½®ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°çš„è¾“å…¥å€¼
            const server = document.getElementById('gitlabServer').value.trim();
            const token = document.getElementById('gitlabToken').value.trim();

            if (!server || !token) {
                showToast('è¯·å…ˆå¡«å†™GitLabæœåŠ¡å™¨åœ°å€å’ŒToken', 'warning');
                return;
            }

            // ä¸´æ—¶æ›´æ–°é…ç½®ç”¨äºæµ‹è¯•ï¼Œä½†ä¸ç«‹å³ä¿å­˜åˆ°localStorage
            const originalConfig = { ...gitlabConfig };
            gitlabConfig.server = server;
            gitlabConfig.token = token;

            showToast('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'warning');
            await apiRequest('/user');

            // æµ‹è¯•æˆåŠŸï¼Œç°åœ¨ä¿å­˜é…ç½®
            localStorage.setItem('gitlab-config', JSON.stringify(gitlabConfig));
            showToast('è¿æ¥æµ‹è¯•æˆåŠŸï¼é…ç½®å·²è‡ªåŠ¨ä¿å­˜', 'success');
        } catch (error) {
            // æµ‹è¯•å¤±è´¥ï¼Œæ¢å¤åŸé…ç½®
            gitlabConfig = originalConfig;
            showToast('è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
        }
    }

    // ====== AI é…ç½®ç®¡ç† ======
    function saveAiConfig() {
        const endpoint = document.getElementById('aiEndpoint').value.trim();
        const apiKey = document.getElementById('aiApiKey').value.trim();
        const model = document.getElementById('aiModel').value.trim();

        if (!endpoint || !apiKey || !model) {
            showToast('è¯·å¡«å†™å®Œæ•´çš„ AI é…ç½®ä¿¡æ¯', 'warning');
            return false;
        }

        aiConfig.endpoint = endpoint;
        aiConfig.apiKey = apiKey;
        aiConfig.model = model;

        try {
            localStorage.setItem('ai-config', JSON.stringify(aiConfig));
            showToast('âœ… AI é…ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨', 'success');
            console.log('AI é…ç½®ä¿å­˜æˆåŠŸ:', { ...aiConfig, apiKey: '***' });

            // æ›´æ–° AI æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            updateAiButtonVisibility();

            return true;
        } catch (error) {
            showToast('âŒ AI é…ç½®ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            console.error('AI é…ç½®ä¿å­˜å¤±è´¥:', error);
            return false;
        }
    }

    async function testAiConnection() {
        // è·å–æµ‹è¯•æŒ‰é’®å…ƒç´ 
        const testBtn = event.target;
        const originalText = testBtn.innerHTML;

        try {
            // ç¦ç”¨æŒ‰é’®å¹¶ä¿®æ”¹æ–‡æ¡ˆ
            testBtn.disabled = true;
            testBtn.innerHTML = '<span class="loading" style="width: 14px; height: 14px; border-width: 2px; margin-right: 4px;"></span> æµ‹è¯•ä¸­...';

            // å…ˆè‡ªåŠ¨ä¿å­˜å½“å‰é…ç½®
            const endpoint = document.getElementById('aiEndpoint').value.trim();
            const apiKey = document.getElementById('aiApiKey').value.trim();
            const model = document.getElementById('aiModel').value.trim();

            if (!endpoint || !apiKey || !model) {
                showToast('è¯·å…ˆå¡«å†™å®Œæ•´çš„ AI é…ç½®ä¿¡æ¯', 'warning');
                return;
            }

            // ä¸´æ—¶æ›´æ–°é…ç½®ç”¨äºæµ‹è¯•
            const originalConfig = { ...aiConfig };
            aiConfig.endpoint = endpoint;
            aiConfig.apiKey = apiKey;
            aiConfig.model = model;

            showToast('æ­£åœ¨æµ‹è¯• AI è¿æ¥...', 'warning');

            // è°ƒç”¨ OpenAI API æµ‹è¯•è¿æ¥
            const response = await fetch(`${aiConfig.endpoint}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${aiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: aiConfig.model,
                    messages: [
                        { role: 'user', content: 'Hello, this is a connection test.' }
                    ],
                    max_tokens: 10
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const data = await response.json();
            console.log('AI æµ‹è¯•å“åº”:', data);

            // æµ‹è¯•æˆåŠŸï¼Œä¿å­˜é…ç½®
            localStorage.setItem('ai-config', JSON.stringify(aiConfig));
            showToast('âœ… AI è¿æ¥æµ‹è¯•æˆåŠŸï¼é…ç½®å·²è‡ªåŠ¨ä¿å­˜', 'success');
        } catch (error) {
            // æµ‹è¯•å¤±è´¥ï¼Œæ¢å¤åŸé…ç½®
            aiConfig = originalConfig;
            showToast('âŒ AI è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            console.error('AI æµ‹è¯•å¤±è´¥:', error);
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            testBtn.disabled = false;
            testBtn.innerHTML = originalText;
        }
    }

    // ====== AI ç”Ÿæˆ MR ä¿¡æ¯ ======
    async function generateMRWithAI() {
        const sourceBranch = document.getElementById('sourceBranch').value;
        const targetBranch = document.getElementById('targetBranch').value;

        if (!sourceBranch || !targetBranch) {
            showToast('è¯·å…ˆé€‰æ‹©æºåˆ†æ”¯å’Œç›®æ ‡åˆ†æ”¯', 'warning');
            return;
        }

        if (selectedProjects.size === 0) {
            showToast('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
            return;
        }

        if (!isAiConfigured()) {
            showToast('è¯·å…ˆé…ç½® AI', 'warning');
            return;
        }

        const aiGenerateBtn = document.getElementById('aiGenerateBtn');
        const originalText = aiGenerateBtn.innerHTML;

        try {
            // ç¦ç”¨æŒ‰é’®å¹¶ä¿®æ”¹æ–‡æ¡ˆ
            aiGenerateBtn.disabled = true;
            aiGenerateBtn.innerHTML = '<span class="loading" style="width: 14px; height: 14px; border-width: 2px; margin-right: 4px;"></span> AI ç”Ÿæˆä¸­...';

            showToast('ğŸ¤– AI æ­£åœ¨ä¸ºæ¯ä¸ªé¡¹ç›®ç”Ÿæˆ MR ä¿¡æ¯...', 'info');

            // æ¸…ç©ºä¹‹å‰çš„ AI ç”Ÿæˆä¿¡æ¯
            aiGeneratedMRInfo.clear();

            const projectIds = Array.from(selectedProjects);
            let completed = 0;

            // æ˜¾ç¤º AI ç”ŸæˆåŒºåŸŸ
            const aiMrInfoSection = document.getElementById('aiMrInfoSection');
            const aiMrInfoContainer = document.getElementById('aiMrInfoContainer');
            aiMrInfoSection.style.display = 'block';
            aiMrInfoContainer.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> AI æ­£åœ¨ç”Ÿæˆä¸­...</div>';

            // ä¸ºæ¯ä¸ªé¡¹ç›®ç”Ÿæˆ MR ä¿¡æ¯
            for (const projectId of projectIds) {
                const project = allProjects.find(p => p.id === projectId);

                try {
                    // è·å–é¡¹ç›®çš„æäº¤å·®å¼‚
                    const comparison = await apiRequest(`/projects/${projectId}/repository/compare?from=${targetBranch}&to=${sourceBranch}`);
                    const commits = comparison.commits || [];

                    // æ„å»ºæäº¤ä¿¡æ¯æ‘˜è¦
                    const commitSummary = commits.slice(0, 10).map(c => `- ${c.title}`).join('\n');

                    // è°ƒç”¨ AI ç”Ÿæˆ MR æ ‡é¢˜å’Œæè¿°ï¼ˆè‹±æ–‡ Promptï¼‰
                    const prompt = `You are a professional code review assistant. Please generate a concise and professional title and description for a GitLab Merge Request based on the following information.

Project Name: ${project.name}
Source Branch: ${sourceBranch}
Target Branch: ${targetBranch}
Number of Commits: ${commits.length}
Recent Commit Messages:
${commitSummary || 'No commit differences'}

Please generate:
1. A concise MR title (no more than 80 characters)
2. A detailed MR description (including change summary, impact scope, etc.)

Please return in JSON format as follows:
{
  "title": "MR Title",
  "description": "MR Description"
}`;

                    const response = await fetch(`${aiConfig.endpoint}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${aiConfig.apiKey}`
                        },
                        body: JSON.stringify({
                            model: aiConfig.model,
                            messages: [
                                { role: 'user', content: prompt }
                            ],
                            temperature: 0.7,
                            max_tokens: 500
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`AI API è¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;

                    // è§£æ AI è¿”å›çš„ JSON
                    let mrInfo;
                    try {
                        // å°è¯•æå– JSONï¼ˆå¯èƒ½åŒ…å«åœ¨ markdown ä»£ç å—ä¸­ï¼‰
                        const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            mrInfo = JSON.parse(jsonMatch[0]);
                        } else {
                            throw new Error('æ— æ³•è§£æ AI å“åº”');
                        }
                    } catch (parseError) {
                        // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼
                        mrInfo = {
                            title: `${sourceBranch} -> ${targetBranch}`,
                            description: aiResponse
                        };
                    }

                    // å­˜å‚¨ AI ç”Ÿæˆçš„ä¿¡æ¯
                    aiGeneratedMRInfo.set(projectId, mrInfo);

                    completed++;
                    showToast(`âœ… å·²ä¸º ${completed}/${projectIds.length} ä¸ªé¡¹ç›®ç”Ÿæˆ MR ä¿¡æ¯`, 'info');

                } catch (error) {
                    console.error(`ä¸ºé¡¹ç›® ${project.name} ç”Ÿæˆ MR ä¿¡æ¯å¤±è´¥:`, error);
                    // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤ä¿¡æ¯
                    aiGeneratedMRInfo.set(projectId, {
                        title: `${sourceBranch} -> ${targetBranch}`,
                        description: `âŒ AI ç”Ÿæˆå¤±è´¥: ${error.message}`
                    });
                    completed++;
                }
            }

            // æ˜¾ç¤ºç”Ÿæˆçš„ MR ä¿¡æ¯
            displayAiGeneratedMRInfo();

            // åˆ‡æ¢åˆ° AI æ¨¡å¼
            switchToAiMode();

            showToast(`âœ… AI å·²ä¸º ${projectIds.length} ä¸ªé¡¹ç›®ç”Ÿæˆ MR ä¿¡æ¯`, 'success');

        } catch (error) {
            console.error('AI ç”Ÿæˆ MR ä¿¡æ¯å¤±è´¥:', error);
            showToast('âŒ AI ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            aiGenerateBtn.disabled = false;
            aiGenerateBtn.innerHTML = originalText;
        }
    }

    // åˆ‡æ¢åˆ° AI æ¨¡å¼
    function switchToAiMode() {
        // éšè—æ‰‹åŠ¨é…ç½®
        document.getElementById('manualMrConfig').style.display = 'none';

        // æ˜¾ç¤º AI æ¨¡å¼æç¤º
        document.getElementById('aiModeHint').style.display = 'block';

        // æ˜¾ç¤ºæŒ‡æ´¾äººå‘˜é…ç½®ï¼ˆAI æ¨¡å¼ä¸‹ä¹Ÿéœ€è¦ï¼‰
        const assigneeConfig = document.getElementById('assigneeConfig');
        const assigneeSelectAi = document.getElementById('assigneeSelectAi');
        const assigneeSelect = document.getElementById('assigneeSelect');

        // åŒæ­¥æŒ‡æ´¾äººå‘˜é€‰é¡¹
        assigneeSelectAi.innerHTML = assigneeSelect.innerHTML;
        assigneeSelectAi.value = assigneeSelect.value;

        assigneeConfig.style.display = 'block';
    }

    // æ¸…é™¤ AI æ¨¡å¼
    function clearAiMode() {
        // æ¸…ç©º AI ç”Ÿæˆçš„ä¿¡æ¯
        aiGeneratedMRInfo.clear();

        // æ˜¾ç¤ºæ‰‹åŠ¨é…ç½®
        document.getElementById('manualMrConfig').style.display = 'block';

        // éšè— AI æ¨¡å¼æç¤º
        document.getElementById('aiModeHint').style.display = 'none';

        // éšè— AI æŒ‡æ´¾é…ç½®
        document.getElementById('assigneeConfig').style.display = 'none';

        // éšè— AI ç”Ÿæˆçš„ MR ä¿¡æ¯å±•ç¤ºåŒºåŸŸ
        document.getElementById('aiMrInfoSection').style.display = 'none';

        showToast('å·²æ¸…é™¤ AI ç”Ÿæˆçš„ä¿¡æ¯', 'success');
    }

    // æ˜¾ç¤º AI ç”Ÿæˆçš„ MR ä¿¡æ¯
    function displayAiGeneratedMRInfo() {
        const aiMrInfoContainer = document.getElementById('aiMrInfoContainer');

        if (aiGeneratedMRInfo.size === 0) {
            aiMrInfoContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">æš‚æ—  AI ç”Ÿæˆçš„ä¿¡æ¯</div>';
            return;
        }

        let html = '';

        aiGeneratedMRInfo.forEach((mrInfo, projectId) => {
            const project = allProjects.find(p => p.id === projectId);
            html += `
                <div style="margin-bottom: 12px; padding: 8px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border: 1px solid var(--border);">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 4px;">
                        ğŸ“¦ ${project.name}
                    </div>
                    <div style="margin-bottom: 4px;">
                        <strong style="color: var(--text);">æ ‡é¢˜:</strong>
                        <span style="color: var(--muted);">${mrInfo.title}</span>
                    </div>
                    <div>
                        <strong style="color: var(--text);">æè¿°:</strong>
                        <div style="color: var(--muted); white-space: pre-wrap; margin-top: 4px; padding: 6px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">${mrInfo.description}</div>
                    </div>
                </div>
            `;
        });

        aiMrInfoContainer.innerHTML = html;
    }

    function exportConfig() {
        const config = {
            server: gitlabConfig.server,
            token: gitlabConfig.token,
            favorites: Array.from(favoriteProjects),
            searchHistory: searchHistory
        };

        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gitlab-config.json';
        a.click();
        URL.revokeObjectURL(url);

        showToast('é…ç½®å·²å¯¼å‡º', 'success');
    }

    function importConfig(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const config = JSON.parse(e.target.result);
                if (config.server) gitlabConfig.server = config.server;
                if (config.token) gitlabConfig.token = config.token;
                if (config.favorites) favoriteProjects = new Set(config.favorites);
                if (config.searchHistory) searchHistory = config.searchHistory;

                // æ›´æ–°ç•Œé¢
                document.getElementById('gitlabServer').value = gitlabConfig.server;
                document.getElementById('gitlabToken').value = gitlabConfig.token;

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveConfig();
                localStorage.setItem('favorite-projects', JSON.stringify(Array.from(favoriteProjects)));
                localStorage.setItem('search-history', JSON.stringify(searchHistory));

                showToast('é…ç½®å·²å¯¼å…¥', 'success');
            } catch (error) {
                showToast('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
            }
        };
        reader.readAsText(file);
    }

    // ====== å·¥å…·å‡½æ•° ======
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type} show`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function updateStats() {
        document.getElementById('totalProjects').textContent = allProjects.length;
        document.getElementById('selectedProjects').textContent = selectedProjects.size;
    }

    function updateSelectedTags() {
        const container = document.getElementById('selectedTagsContainer');
        const tagsContainer = document.getElementById('selectedTags');
        const countSpan = document.getElementById('selectedTagsCount');

        if (selectedProjects.size === 0) {
            container.classList.remove('show');
            return;
        }

        container.classList.add('show');
        countSpan.textContent = selectedProjects.size;

        const selectedProjectObjects = Array.from(selectedProjects).map(id =>
            allProjects.find(p => p.id === id)
        ).filter(Boolean);

        tagsContainer.innerHTML = selectedProjectObjects.map(project => `
            <div class="selected-tag" onclick="removeSelectedTag(${project.id})">
                <span>${project.name_with_namespace || project.name}</span>
                <span class="remove-icon">Ã—</span>
            </div>
        `).join('');
    }

    function removeSelectedTag(projectId) {
        selectedProjects.delete(projectId);
        renderProjects();
        updateStats();
        updateButtonStates();

        if (selectedProjects.size > 0) {
            loadCommonBranches();
        } else {
            clearBranches();
        }

        showToast('å·²ç§»é™¤é¡¹ç›®', 'success');
    }

    function clearSelectedTags() {
        if (selectedProjects.size === 0) {
            showToast('æ²¡æœ‰å·²é€‰æ‹©çš„é¡¹ç›®', 'warning');
            return;
        }

        if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²é€‰æ‹©çš„ ${selectedProjects.size} ä¸ªé¡¹ç›®å—ï¼Ÿ`)) {
            selectedProjects.clear();
            renderProjects();
            updateStats();
            updateButtonStates();
            clearBranches();
            showToast('å·²æ¸…ç©ºæ‰€æœ‰é€‰æ‹©', 'success');
        }
    }

    function updateButtonStates() {
        const hasSelection = selectedProjects.size > 0;
        const hasAiConfig = isAiConfigured();

        document.getElementById('previewBtn').disabled = !hasSelection;
        document.getElementById('createBtn').disabled = !hasSelection;

        // AI ç”ŸæˆæŒ‰é’®ï¼šéœ€è¦é€‰æ‹©é¡¹ç›® + é…ç½®äº† AI
        const aiGenerateBtn = document.getElementById('aiGenerateBtn');
        if (aiGenerateBtn) {
            aiGenerateBtn.disabled = !hasSelection || !hasAiConfig;
        }
    }

    function highlightText(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }

    // ç®€å•çš„æ‹¼éŸ³é¦–å­—æ¯åŒ¹é…
    function matchesPinyin(text, query) {
        const pinyinMap = {
            'a': 'é˜¿å•Š', 'b': 'ç™½ä¸', 'c': 'å‚æ‰', 'd': 'å¤§åœ°', 'e': 'é¢è€Œ',
            'f': 'å‘æˆ¿', 'g': 'å·¥é«˜', 'h': 'è¿˜å¥½', 'i': 'ä¸€', 'j': 'å°±å®¶',
            'k': 'å¯å¼€', 'l': 'äº†æ¥', 'm': 'æ²¡ä¹ˆ', 'n': 'ä½ é‚£', 'o': 'å“¦',
            'p': 'å¹³ç¥¨', 'q': 'å»å‰', 'r': 'äººå¦‚', 's': 'æ˜¯æ—¶', 't': 'å¤©ä»–',
            'u': 'æœ‰', 'v': 'äº”', 'w': 'æˆ‘', 'x': 'å°æ–°', 'y': 'è¦æœ‰', 'z': 'åœ¨ä¸­'
        };

        // å¦‚æœæŸ¥è¯¢æ˜¯è‹±æ–‡å­—æ¯ï¼Œæ£€æŸ¥æ˜¯å¦åŒ¹é…ä¸­æ–‡é¦–å­—æ¯
        if (/^[a-zA-Z]+$/.test(query)) {
            return query.split('').every(char => {
                const pinyin = pinyinMap[char.toLowerCase()];
                return pinyin && text.split('').some(textChar => pinyin.includes(textChar));
            });
        }

        return text.toLowerCase().includes(query.toLowerCase());
    }

    // ====== API è¯·æ±‚å‡½æ•° ======
    async function apiRequest(endpoint, options = {}) {
        // åœ¨æ¯æ¬¡APIè°ƒç”¨å‰åŒæ­¥æœ€æ–°çš„è¾“å…¥æ¡†é…ç½®
        syncConfigFromInputs();

        const url = `${gitlabConfig.server}/api/v4${endpoint}`;
        const response = await fetch(url, {
            headers: {
                'Private-Token': gitlabConfig.token,
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`);
        }

        return response.json();
    }

    // ====== åˆ†é¡µAPIè¯·æ±‚å‡½æ•° ======
    async function getAllPaginatedData(endpoint, maxPages = 50) {
        let allData = [];
        let page = 1;
        const perPage = 100; // GitLab APIæœ€å¤§æ¯é¡µ100æ¡
        const startTime = performance.now();

        console.log(`ğŸ”„ å¼€å§‹åˆ†é¡µåŠ è½½: ${endpoint}`);

        while (page <= maxPages) {
            const separator = endpoint.includes('?') ? '&' : '?';
            const paginatedEndpoint = `${endpoint}${separator}per_page=${perPage}&page=${page}`;

            try {
                const pageStartTime = performance.now();
                const data = await apiRequest(paginatedEndpoint);
                const pageEndTime = performance.now();

                if (!Array.isArray(data) || data.length === 0) {
                    console.log(`ğŸ“„ ç¬¬ ${page} é¡µæ— æ•°æ®ï¼ŒåŠ è½½ç»“æŸ`);
                    break; // æ²¡æœ‰æ›´å¤šæ•°æ®
                }

                allData = allData.concat(data);
                console.log(`ğŸ“„ ç¬¬ ${page} é¡µåŠ è½½å®Œæˆ: ${data.length} æ¡æ•°æ® (${Math.round(pageEndTime - pageStartTime)}ms)`);

                // å¦‚æœè¿”å›çš„æ•°æ®å°‘äºæ¯é¡µæ•°é‡ï¼Œè¯´æ˜æ˜¯æœ€åä¸€é¡µ
                if (data.length < perPage) {
                    console.log(`ğŸ“„ ç¬¬ ${page} é¡µæ˜¯æœ€åä¸€é¡µ (${data.length} < ${perPage})`);
                    break;
                }

                page++;
            } catch (error) {
                console.error(`âŒ è·å–ç¬¬ ${page} é¡µæ•°æ®å¤±è´¥:`, error);
                break;
            }
        }

        const endTime = performance.now();
        const totalTime = Math.round(endTime - startTime);
        console.log(`âœ… åˆ†é¡µåŠ è½½å®Œæˆ: å…± ${allData.length} æ¡æ•°æ®ï¼Œ${page - 1} é¡µï¼Œè€—æ—¶ ${totalTime}ms`);

        return allData;
    }

    // ====== æ¸è¿›å¼åˆ†é¡µåŠ è½½å‡½æ•°ï¼ˆæ¯æ¬¡10æ¡ï¼Œç«‹å³æ¸²æŸ“ï¼‰======
    async function getProgressivePaginatedData(endpoint, onPageLoaded, maxPages = 100) {
        let allData = [];
        let page = 1;
        const perPage = 10; // æ¯æ¬¡åªåŠ è½½10æ¡ï¼Œå¿«é€Ÿå“åº”
        const startTime = performance.now();

        console.log(`ğŸš€ å¼€å§‹æ¸è¿›å¼åŠ è½½: ${endpoint}`);

        while (page <= maxPages) {
            const separator = endpoint.includes('?') ? '&' : '?';
            const paginatedEndpoint = `${endpoint}${separator}per_page=${perPage}&page=${page}`;

            try {
                const pageStartTime = performance.now();
                const data = await apiRequest(paginatedEndpoint);
                const pageEndTime = performance.now();

                if (!Array.isArray(data) || data.length === 0) {
                    console.log(`ğŸ“„ ç¬¬ ${page} é¡µæ— æ•°æ®ï¼ŒåŠ è½½ç»“æŸ`);
                    break;
                }

                allData = allData.concat(data);
                console.log(`ğŸ“„ ç¬¬ ${page} é¡µåŠ è½½å®Œæˆ: ${data.length} æ¡æ•°æ® (${Math.round(pageEndTime - pageStartTime)}ms)`);

                // ç«‹å³å›è°ƒæ¸²æŸ“å½“å‰é¡µæ•°æ®
                if (onPageLoaded) {
                    onPageLoaded(data, allData.length, page);
                }

                // å¦‚æœè¿”å›çš„æ•°æ®å°‘äºæ¯é¡µæ•°é‡ï¼Œè¯´æ˜æ˜¯æœ€åä¸€é¡µ
                if (data.length < perPage) {
                    console.log(`ğŸ“„ ç¬¬ ${page} é¡µæ˜¯æœ€åä¸€é¡µ (${data.length} < ${perPage})`);
                    break;
                }

                page++;
            } catch (error) {
                console.error(`âŒ è·å–ç¬¬ ${page} é¡µæ•°æ®å¤±è´¥:`, error);
                break;
            }
        }

        const endTime = performance.now();
        const totalTime = Math.round(endTime - startTime);
        console.log(`âœ… æ¸è¿›å¼åŠ è½½å®Œæˆ: å…± ${allData.length} æ¡æ•°æ®ï¼Œ${page - 1} é¡µï¼Œè€—æ—¶ ${totalTime}ms`);

        return allData;
    }

    // ====== è·å–é¡¹ç›®æ‰€æœ‰åˆ†æ”¯ ======
    async function getAllProjectBranches(projectId) {
        // ä½¿ç”¨é…ç½®ç›¸å…³çš„ç¼“å­˜é”®ï¼Œç¡®ä¿ä¸åŒé…ç½®æœ‰ç‹¬ç«‹ç¼“å­˜
        const configHash = getConfigHash();
        const cacheKey = `all-branches-${configHash}-${projectId}`;
        const cached = sessionStorage.getItem(cacheKey);

        // æ£€æŸ¥ç¼“å­˜ï¼ˆ30åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
        if (cached) {
            const cacheData = JSON.parse(cached);
            const cacheTime = new Date(cacheData.timestamp);
            const now = new Date();
            if (now - cacheTime < 30 * 60 * 1000) { // 30åˆ†é’Ÿ
                console.log(`ğŸ“¦ ä½¿ç”¨åˆ†æ”¯ç¼“å­˜: é¡¹ç›®${projectId}, é…ç½®${configHash}`);
                return cacheData.branches;
            }
        }

        console.log(`ğŸ”„ è·å–é¡¹ç›® ${projectId} çš„æ‰€æœ‰åˆ†æ”¯ (é…ç½®: ${configHash})...`);
        const branches = await getAllPaginatedData(`/projects/${projectId}/repository/branches`);

        // ç¼“å­˜ç»“æœ
        const cacheData = {
            branches: branches,
            timestamp: new Date().toISOString(),
            configHash: configHash
        };
        sessionStorage.setItem(cacheKey, JSON.stringify(cacheData));
        console.log(`ğŸ’¾ åˆ†æ”¯æ•°æ®å·²ç¼“å­˜: é¡¹ç›®${projectId}, é…ç½®${configHash}, ${branches.length}ä¸ªåˆ†æ”¯`);

        return branches;
    }

    // ====== é¡¹ç›®ç®¡ç† ======
    async function loadProjects(forceRefresh = false) {
        const refreshBtn = document.getElementById('refreshBtn');
        const loading = document.getElementById('refreshLoading');
        const selector = document.getElementById('projectSelector');

        refreshBtn.disabled = true;
        loading.classList.remove('hidden');

        try {
            // é‡æ–°åŠ è½½æœ€æ–°é…ç½®ï¼Œç¡®ä¿ä½¿ç”¨localStorageä¸­çš„æœ€æ–°token
            console.log('ğŸ”„ åˆ·æ–°å‰é…ç½®:', gitlabConfig);
            loadConfig();
            console.log('ğŸ”„ åˆ·æ–°åé…ç½®:', gitlabConfig);

            // éªŒè¯é…ç½®å®Œæ•´æ€§
            if (!gitlabConfig.server || !gitlabConfig.token) {
                throw new Error('GitLabé…ç½®ä¸å®Œæ•´ï¼Œè¯·å…ˆè®¾ç½®æœåŠ¡å™¨åœ°å€å’Œè®¿é—®Token');
            }

            // ç”Ÿæˆé…ç½®ç›¸å…³çš„ç¼“å­˜é”®ï¼Œç¡®ä¿ä¸åŒé…ç½®ä½¿ç”¨ä¸åŒç¼“å­˜
            const configHash = getConfigHash();
            const cacheKey = `gitlab-projects-${configHash}`;
            const cacheTimeKey = `gitlab-projects-time-${configHash}`;

            console.log(`ğŸ”‘ ä½¿ç”¨é¡¹ç›®ç¼“å­˜é”®: ${cacheKey}`);

            let useCache = false;
            const now = Date.now();

            // æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼ˆé¡µé¢æ‰“å¼€æ—¶å…è®¸ä½¿ç”¨ç¼“å­˜ï¼Œå¼ºåˆ¶åˆ·æ–°æ—¶ä¸ä½¿ç”¨ï¼‰
            if (!forceRefresh) {
                const cached = localStorage.getItem(cacheKey);
                const cacheTime = localStorage.getItem(cacheTimeKey);

                if (cached && cacheTime && (now - parseInt(cacheTime)) < 300000) { // 5åˆ†é’Ÿç¼“å­˜
                    allProjects = JSON.parse(cached);
                    showToast(`ğŸ“¦ ä»ç¼“å­˜åŠ è½½é¡¹ç›® (${configHash})`, 'success');
                    console.log(`ğŸ“¦ ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œé…ç½®æ ‡è¯†: ${configHash}`);
                    useCache = true;
                }
            }

            // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–ç¼“å­˜ä¸å¯ç”¨ï¼Œä»APIè·å–æœ€æ–°æ•°æ®
            if (!useCache) {
                if (forceRefresh) {
                    showToast('ğŸ”„ å¼ºåˆ¶åˆ·æ–°ï¼Œè·å–æœ€æ–°é¡¹ç›®æ•°æ®...', 'info');
                    console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ¨¡å¼ï¼Œè·³è¿‡ç¼“å­˜');
                } else {
                    showToast('â³ å¼€å§‹æ¸è¿›å¼åŠ è½½é¡¹ç›®åˆ—è¡¨...', 'info');
                    console.log('ğŸ“¡ ç¼“å­˜ä¸å¯ç”¨ï¼Œä½¿ç”¨æ¸è¿›å¼åŠ è½½');
                }

                // æ¸…ç©ºallProjectsï¼Œå‡†å¤‡æ¸è¿›å¼åŠ è½½
                allProjects = [];

                // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
                selector.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;"><div class="loading" style="margin: 0 auto 15px;"></div>æ­£åœ¨åŠ è½½é¡¹ç›®åˆ—è¡¨...</div>';

                // ä½¿ç”¨æ¸è¿›å¼åˆ†é¡µåŠ è½½ï¼Œæ¯æ¬¡10æ¡ï¼Œç«‹å³æ¸²æŸ“
                await getProgressivePaginatedData(
                    '/projects?order_by=last_activity_at&sort=desc',
                    (pageData, totalLoaded, pageNum) => {
                        // æ¯åŠ è½½ä¸€é¡µå°±ç«‹å³è¿½åŠ åˆ°allProjectså¹¶æ¸²æŸ“
                        allProjects = allProjects.concat(pageData);

                        console.log(`ğŸ¨ æ¸è¿›å¼æ¸²æŸ“: ç¬¬${pageNum}é¡µï¼Œå½“å‰å…±${totalLoaded}ä¸ªé¡¹ç›®`);

                        // ç«‹å³æ¸²æŸ“å½“å‰å·²åŠ è½½çš„é¡¹ç›®
                        renderProjectsProgressive();
                        updateStats();

                        // æ›´æ–°åŠ è½½æç¤º
                        showToast(`ğŸ“¦ å·²åŠ è½½ ${totalLoaded} ä¸ªé¡¹ç›®...`, 'info');
                    },
                    100 // æœ€å¤š100é¡µï¼Œæ¯é¡µ10ä¸ªï¼Œå…±1000ä¸ªé¡¹ç›®
                );

                // ä¿å­˜åˆ°é…ç½®ç›¸å…³çš„ç¼“å­˜é”®ï¼Œè¦†ç›–æ—§ç¼“å­˜
                localStorage.setItem(cacheKey, JSON.stringify(allProjects));
                localStorage.setItem(cacheTimeKey, now.toString());

                console.log(`ğŸ’¾ é¡¹ç›®æ•°æ®å·²æ›´æ–°ç¼“å­˜ï¼Œé…ç½®æ ‡è¯†: ${configHash}ï¼Œå…± ${allProjects.length} ä¸ªé¡¹ç›®`);
            }

            // åˆå§‹åŒ–æŠ˜å çŠ¶æ€ï¼šä¼˜å…ˆä»localStorageæ¢å¤ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤è§„åˆ™
            const savedCollapsedGroups = localStorage.getItem('collapsed-groups');
            if (savedCollapsedGroups) {
                // æ¢å¤ç”¨æˆ·ä¸Šæ¬¡çš„æŠ˜å çŠ¶æ€
                collapsedGroups = new Set(JSON.parse(savedCollapsedGroups));
                console.log('ğŸ“¦ æ¢å¤æŠ˜å çŠ¶æ€:', Array.from(collapsedGroups));
            } else {
                // é¦–æ¬¡åŠ è½½ï¼šåªå±•å¼€é‡è¦åˆ†ç»„ï¼ˆNEXGO HUBã€MPoCã€sscï¼‰ï¼Œå…¶ä»–é»˜è®¤æŠ˜å 
                const importantGroups = ['NEXGO HUB', 'MPoC', 'ssc'];
                const groupedProjects = groupProjectsByNamespace(allProjects);
                collapsedGroups.clear();
                Object.keys(groupedProjects).forEach(groupName => {
                    if (!importantGroups.includes(groupName)) {
                        collapsedGroups.add(groupName);
                    }
                });
                console.log('ğŸ†• ä½¿ç”¨é»˜è®¤æŠ˜å çŠ¶æ€:', Array.from(collapsedGroups));
            }

            // æœ€ç»ˆå®Œæ•´æ¸²æŸ“ä¸€æ¬¡ï¼ˆå¦‚æœä½¿ç”¨ç¼“å­˜ï¼‰
            if (useCache) {
                renderProjects();
                updateStats();
            }

            // æ›´æ–°åˆ·æ–°æŒ‰é’®çš„æ ‡é¢˜ï¼Œæ˜¾ç¤ºå½“å‰é…ç½®ä¿¡æ¯
            const serverHost = gitlabConfig.server.replace(/^https?:\/\//, '').split('/')[0];
            refreshBtn.title = `å½“å‰é…ç½®: ${serverHost} (${configHash})`;

            // æ ¹æ®æ•°æ®æ¥æºæ˜¾ç¤ºä¸åŒçš„æˆåŠŸæ¶ˆæ¯
            if (forceRefresh) {
                showToast(`âœ… åˆ·æ–°å®Œæˆï¼è·å–åˆ° ${allProjects.length} ä¸ªæœ€æ–°é¡¹ç›® (${configHash})`, 'success');
            } else if (useCache) {
                // ç¼“å­˜åŠ è½½çš„æ¶ˆæ¯å·²ç»åœ¨ä¸Šé¢æ˜¾ç¤ºäº†
            } else {
                showToast(`âœ… æ¸è¿›å¼åŠ è½½å®Œæˆï¼å…± ${allProjects.length} ä¸ªé¡¹ç›® (${configHash})`, 'success');
            }
        } catch (error) {
            console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', error);
            showToast('åŠ è½½é¡¹ç›®å¤±è´¥: ' + error.message, 'error');
            document.getElementById('projectSelector').innerHTML =
                '<div style="padding: 40px; text-align: center; color: #dc3545;">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œè¿æ¥</div>';
        } finally {
            refreshBtn.disabled = false;
            loading.classList.add('hidden');
        }
    }

    // ====== æ¸è¿›å¼æ¸²æŸ“å‡½æ•°ï¼ˆè¿½åŠ æ¨¡å¼ï¼Œä¸æ¸…ç©ºç°æœ‰å†…å®¹ï¼‰======
    function renderProjectsProgressive() {
        const selector = document.getElementById('projectSelector');
        const query = document.getElementById('projectSearch').value.toLowerCase();

        if (allProjects.length === 0) {
            selector.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">æš‚æ— é¡¹ç›®</div>';
            return;
        }

        // æŒ‰ç»„ç»‡åˆ†ç»„é¡¹ç›®
        const groupedProjects = groupProjectsByNamespace(allProjects);

        // æ¸²æŸ“åˆ†ç»„é¡¹ç›®
        let html = '';

        // ä½¿ç”¨è‡ªå®šä¹‰æ’åº
        const sortedGroupNames = sortGroupNames(Object.keys(groupedProjects));

        sortedGroupNames.forEach(groupName => {
            const groupProjects = groupedProjects[groupName];
            const selectedInGroup = groupProjects.filter(p => selectedProjects.has(p.id)).length;
            const isCollapsed = collapsedGroups.has(groupName);

            // åˆ†ç»„æ ‡é¢˜
            html += `
                <div class="group-header">
                    <span class="group-toggle ${isCollapsed ? 'collapsed' : ''}" onclick="toggleGroup('${groupName}'); event.stopPropagation();">â–¼</span>
                    <span class="group-name" onclick="toggleGroup('${groupName}'); event.stopPropagation();">ğŸ“ ${groupName}</span>
                    <span class="group-stats">${selectedInGroup}/${groupProjects.length}</span>
                    <button class="btn btn-secondary" onclick="toggleGroupSelection('${groupName}'); event.stopPropagation();"
                            style="padding: 2px 6px; font-size: 11px; margin-left: 8px;">
                        ${selectedInGroup === groupProjects.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}
                    </button>
                </div>
            `;

            // åˆ†ç»„å†…å®¹
            html += `<div class="group-content ${isCollapsed ? 'collapsed' : ''}" id="group-${groupName.replace(/[^a-zA-Z0-9]/g, '-')}">`;

            groupProjects.forEach(project => {
                const isFavorite = favoriteProjects.has(project.id);
                // æ˜¾ç¤ºå®Œæ•´çš„é¡¹ç›®è·¯å¾„ï¼Œä½†é«˜äº®æœç´¢æ—¶åªé’ˆå¯¹é¡¹ç›®å
                const displayName = project.name_with_namespace || project.name;
                const highlightedName = query ?
                    displayName.replace(new RegExp(`(${query})`, 'gi'), '<span class="highlight">$1</span>') :
                    displayName;

                html += `
                    <div class="project-item ${selectedProjects.has(project.id) ? 'selected' : ''}"
                         onclick="toggleProject(${project.id})" data-project-id="${project.id}">
                        <input type="checkbox" class="project-checkbox"
                               ${selectedProjects.has(project.id) ? 'checked' : ''}
                               onchange="toggleProject(${project.id})" onclick="event.stopPropagation()">
                        <div class="project-name">${highlightedName}</div>
                        <span onclick="toggleFavorite(${project.id}, event)" style="cursor: pointer; font-size: 16px;">
                            ${isFavorite ? 'â­' : 'â˜†'}
                        </span>
                    </div>
                `;
            });

            html += '</div>';
        });

        selector.innerHTML = html;
        updateSelectedTags();
    }

    function renderProjects(filteredProjects = null) {
        const projects = filteredProjects || allProjects;
        const selector = document.getElementById('projectSelector');
        const query = document.getElementById('projectSearch').value.toLowerCase();

        if (projects.length === 0) {
            selector.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">æš‚æ— é¡¹ç›®</div>';
            return;
        }

        // æŒ‰ç»„ç»‡åˆ†ç»„é¡¹ç›®
        const groupedProjects = groupProjectsByNamespace(projects);

        // æ¸²æŸ“åˆ†ç»„é¡¹ç›®
        let html = '';

        // ä½¿ç”¨è‡ªå®šä¹‰æ’åº
        const sortedGroupNames = sortGroupNames(Object.keys(groupedProjects));

        sortedGroupNames.forEach(groupName => {
            const groupProjects = groupedProjects[groupName];
            const selectedInGroup = groupProjects.filter(p => selectedProjects.has(p.id)).length;
            const isCollapsed = collapsedGroups.has(groupName);

            // åˆ†ç»„æ ‡é¢˜
            html += `
                <div class="group-header">
                    <span class="group-toggle ${isCollapsed ? 'collapsed' : ''}" onclick="toggleGroup('${groupName}'); event.stopPropagation();">â–¼</span>
                    <span class="group-name" onclick="toggleGroup('${groupName}'); event.stopPropagation();">ğŸ“ ${groupName}</span>
                    <span class="group-stats">${selectedInGroup}/${groupProjects.length}</span>
                    <button class="btn btn-secondary" onclick="toggleGroupSelection('${groupName}'); event.stopPropagation();"
                            style="padding: 2px 6px; font-size: 11px; margin-left: 8px;">
                        ${selectedInGroup === groupProjects.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}
                    </button>
                </div>
            `;

            // åˆ†ç»„å†…å®¹
            html += `<div class="group-content ${isCollapsed ? 'collapsed' : ''}" id="group-${groupName.replace(/[^a-zA-Z0-9]/g, '-')}">`;

            groupProjects.forEach(project => {
                const isFavorite = favoriteProjects.has(project.id);
                // æ˜¾ç¤ºå®Œæ•´çš„é¡¹ç›®è·¯å¾„ï¼Œä½†é«˜äº®æœç´¢æ—¶åªé’ˆå¯¹é¡¹ç›®å
                const displayName = project.name_with_namespace || project.name;
                const highlightedName = query ?
                    displayName.replace(new RegExp(`(${query})`, 'gi'), '<span class="highlight">$1</span>') :
                    displayName;

                html += `
                    <div class="project-item ${selectedProjects.has(project.id) ? 'selected' : ''}"
                         onclick="toggleProject(${project.id})" data-project-id="${project.id}">
                        <input type="checkbox" class="project-checkbox"
                               ${selectedProjects.has(project.id) ? 'checked' : ''}
                               onchange="toggleProject(${project.id})" onclick="event.stopPropagation()">
                        <div class="project-name">${highlightedName}</div>
                        <span onclick="toggleFavorite(${project.id}, event)" style="cursor: pointer; font-size: 16px;">
                            ${isFavorite ? 'â­' : 'â˜†'}
                        </span>
                    </div>
                `;
            });

            html += '</div>';
        });

        selector.innerHTML = html;
        updateSelectedTags();
    }

    function groupProjectsByNamespace(projects) {
        const groups = {};

        projects.forEach(project => {
            // ä»å®Œæ•´é¡¹ç›®åä¸­æå–ç¬¬ä¸€éƒ¨åˆ†ä½œä¸ºåˆ†ç»„å
            const fullName = project.name_with_namespace || project.name || '';
            const groupName = fullName.split(' / ')[0] || 'æœªåˆ†ç»„';

            if (!groups[groupName]) {
                groups[groupName] = [];
            }
            groups[groupName].push(project);
        });

        return groups;
    }

    function sortGroupNames(groupNames) {
        // è‡ªå®šä¹‰åˆ†ç»„æ’åºï¼šNEXGO HUBç¬¬ä¸€ï¼ŒMPoCç¬¬äºŒï¼Œsscç¬¬ä¸‰ï¼Œå…¶ä»–æŒ‰å­—æ¯æ’åº
        return groupNames.sort((a, b) => {
            const priority = { 'NEXGO HUB': 1, 'MPoC': 2, 'ssc': 3 };
            const aPriority = priority[a] || 999;
            const bPriority = priority[b] || 999;

            if (aPriority !== bPriority) {
                return aPriority - bPriority;
            }
            return a.localeCompare(b);
        });
    }

    function toggleGroup(groupName) {
        if (collapsedGroups.has(groupName)) {
            collapsedGroups.delete(groupName);
        } else {
            collapsedGroups.add(groupName);
        }

        // ä¿å­˜æŠ˜å çŠ¶æ€åˆ°localStorage
        localStorage.setItem('collapsed-groups', JSON.stringify(Array.from(collapsedGroups)));

        // æ›´æ–°UI
        const groupContent = document.getElementById(`group-${groupName.replace(/[^a-zA-Z0-9]/g, '-')}`);
        const groupToggle = groupContent.previousElementSibling.querySelector('.group-toggle');

        if (collapsedGroups.has(groupName)) {
            groupContent.classList.add('collapsed');
            groupToggle.classList.add('collapsed');
        } else {
            groupContent.classList.remove('collapsed');
            groupToggle.classList.remove('collapsed');
        }
    }

    function toggleGroupSelection(groupName) {
        const groupProjects = allProjects.filter(project => {
            // ä»å®Œæ•´é¡¹ç›®åä¸­æå–ç¬¬ä¸€éƒ¨åˆ†ä½œä¸ºåˆ†ç»„åè¿›è¡ŒåŒ¹é…
            const fullName = project.name_with_namespace || project.name || '';
            const projectGroupName = fullName.split(' / ')[0] || 'æœªåˆ†ç»„';
            return projectGroupName === groupName;
        });

        // æ£€æŸ¥åˆ†ç»„å†…é¡¹ç›®çš„é€‰æ‹©çŠ¶æ€
        const selectedInGroup = groupProjects.filter(p => selectedProjects.has(p.id)).length;
        const shouldSelectAll = selectedInGroup < groupProjects.length;

        if (shouldSelectAll) {
            // å…¨é€‰åˆ†ç»„å†…é¡¹ç›®
            groupProjects.forEach(project => selectedProjects.add(project.id));
            showToast(`å·²é€‰æ‹© ${groupProjects.length} ä¸ªé¡¹ç›® (${groupName})`, 'success');
        } else {
            // å–æ¶ˆé€‰æ‹©åˆ†ç»„å†…é¡¹ç›®
            groupProjects.forEach(project => selectedProjects.delete(project.id));
            showToast(`å·²å–æ¶ˆé€‰æ‹© ${groupProjects.length} ä¸ªé¡¹ç›® (${groupName})`, 'success');
        }

        renderProjects();
        updateStats();
        updateButtonStates();

        if (selectedProjects.size > 0) {
            loadCommonBranches();
        } else {
            clearBranches();
        }
    }

    function toggleProject(projectId) {
        if (selectedProjects.has(projectId)) {
            selectedProjects.delete(projectId);
        } else {
            selectedProjects.add(projectId);
        }

        // åªæ›´æ–°å½“å‰é¡¹ç›®çš„DOMçŠ¶æ€ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
        const projectItem = document.querySelector(`.project-item[data-project-id="${projectId}"]`);
        if (projectItem) {
            const checkbox = projectItem.querySelector('.project-checkbox');
            if (selectedProjects.has(projectId)) {
                projectItem.classList.add('selected');
                if (checkbox) checkbox.checked = true;
            } else {
                projectItem.classList.remove('selected');
                if (checkbox) checkbox.checked = false;
            }
        }

        updateStats();
        updateButtonStates();
        updateSelectedTags();

        if (selectedProjects.size > 0) {
            loadCommonBranches();
        } else {
            clearBranches();
        }
    }

    function toggleFavorite(projectId, event) {
        event.stopPropagation();

        if (favoriteProjects.has(projectId)) {
            favoriteProjects.delete(projectId);
        } else {
            favoriteProjects.add(projectId);
        }

        localStorage.setItem('favorite-projects', JSON.stringify(Array.from(favoriteProjects)));
        renderProjects();
        showToast(favoriteProjects.has(projectId) ? 'å·²æ·»åŠ åˆ°æ”¶è—' : 'å·²ä»æ”¶è—ç§»é™¤', 'success');
    }

    function selectAll() {
        const visibleProjects = getFilteredProjects();
        visibleProjects.forEach(project => selectedProjects.add(project.id));
        renderProjects();
        updateStats();
        updateButtonStates();
        loadCommonBranches();
        showToast(`å·²é€‰æ‹© ${visibleProjects.length} ä¸ªå¯è§é¡¹ç›®`, 'success');
    }

    function selectNone() {
        const previousCount = selectedProjects.size;
        selectedProjects.clear();
        renderProjects();
        updateStats();
        updateButtonStates();
        clearBranches();
        if (previousCount > 0) {
            showToast(`å·²æ¸…ç©º ${previousCount} ä¸ªé€‰æ‹©`, 'success');
        }
    }

    function selectFavorites() {
        let addedCount = 0;
        favoriteProjects.forEach(projectId => {
            if (allProjects.find(p => p.id === projectId) && !selectedProjects.has(projectId)) {
                selectedProjects.add(projectId);
                addedCount++;
            }
        });
        renderProjects();
        updateStats();
        updateButtonStates();
        if (selectedProjects.size > 0) {
            loadCommonBranches();
        }
        showToast(`å·²é€‰æ‹© ${addedCount} ä¸ªæ”¶è—é¡¹ç›®`, 'success');
    }

    function getFilteredProjects() {
        const query = document.getElementById('projectSearch').value.toLowerCase().trim();
        if (!query) return allProjects;

        return allProjects.filter(project =>
            project.name_with_namespace.toLowerCase().includes(query) ||
            project.name.toLowerCase().includes(query) ||
            project.namespace.name.toLowerCase().includes(query) ||
            matchesPinyin(project.name_with_namespace, query)
        );
    }

    // ====== åˆ†æ”¯ç®¡ç† ======
    async function loadCommonBranches() {
        if (selectedProjects.size === 0) return;

        const sourceBranch = document.getElementById('sourceBranch');
        const targetBranch = document.getElementById('targetBranch');
        const selectedProjectsArray = Array.from(selectedProjects);

        sourceBranch.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
        targetBranch.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

        try {
            const totalProjects = selectedProjectsArray.length;
            let completedProjects = 0;

            // æ˜¾ç¤ºè¯¦ç»†è¿›åº¦
            showToast(`å¼€å§‹åŠ è½½ ${totalProjects} ä¸ªé¡¹ç›®çš„åˆ†æ”¯ä¿¡æ¯...`, 'info');

            const branchPromises = selectedProjectsArray.map(async (projectId, index) => {
                try {
                    const branches = await getAllProjectBranches(projectId);
                    completedProjects++;

                    // æ›´æ–°è¿›åº¦
                    const progress = Math.round((completedProjects / totalProjects) * 100);
                    sourceBranch.innerHTML = `<option value="">åŠ è½½ä¸­... ${progress}% (${completedProjects}/${totalProjects})</option>`;
                    targetBranch.innerHTML = `<option value="">åŠ è½½ä¸­... ${progress}% (${completedProjects}/${totalProjects})</option>`;

                    console.log(`é¡¹ç›® ${projectId} åˆ†æ”¯åŠ è½½å®Œæˆï¼Œå…± ${branches.length} ä¸ªåˆ†æ”¯`);
                    return branches;
                } catch (error) {
                    console.error(`é¡¹ç›® ${projectId} åˆ†æ”¯åŠ è½½å¤±è´¥:`, error);
                    completedProjects++;
                    // è¿”å›ç©ºæ•°ç»„ï¼Œè¿™æ ·ä¸ä¼šé˜»æ­¢å…¶ä»–é¡¹ç›®çš„å¤„ç†
                    return [];
                }
            });

            const allBranchesResults = await Promise.all(branchPromises);

            // è®¡ç®—äº¤é›†
            let commonBranches = null;
            let totalBranchesCount = 0;

            allBranchesResults.forEach((branches, index) => {
                const projectId = selectedProjectsArray[index];
                const branchNames = branches.map(b => b.name);
                totalBranchesCount += branches.length;

                console.log(`é¡¹ç›® ${projectId}: ${branches.length} ä¸ªåˆ†æ”¯`);

                if (commonBranches === null) {
                    commonBranches = new Set(branchNames);
                } else {
                    commonBranches = new Set([...commonBranches].filter(name => branchNames.includes(name)));
                }
            });

            const commonBranchArray = Array.from(commonBranches || []).sort();

            // æ›´æ–°åˆ†æ”¯é€‰æ‹©å™¨
            const branchOptions = commonBranchArray.map(name =>
                `<option value="${name}">${name}</option>`
            ).join('');

            sourceBranch.innerHTML = `<option value="">é€‰æ‹©æºåˆ†æ”¯</option>${branchOptions}`;
            targetBranch.innerHTML = `<option value="">é€‰æ‹©ç›®æ ‡åˆ†æ”¯</option>${branchOptions}`;

            // è‡ªåŠ¨é€‰æ‹©å¸¸ç”¨åˆ†æ”¯
            const priorityBranches = ['master', 'main', 'develop', 'dev'];
            for (const branch of priorityBranches) {
                if (commonBranchArray.includes(branch)) {
                    targetBranch.value = branch;
                    break;
                }
            }

            // åˆ·æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
            refreshCustomSelect('sourceBranch');
            refreshCustomSelect('targetBranch');

            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('commonBranches').textContent = commonBranchArray.length;

            // æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
            const avgBranches = Math.round(totalBranchesCount / totalProjects);
            showToast(
                `âœ… åˆ†æ”¯åŠ è½½å®Œæˆï¼å…±åŒåˆ†æ”¯: ${commonBranchArray.length}ä¸ªï¼Œå¹³å‡æ¯é¡¹ç›®: ${avgBranches}ä¸ªåˆ†æ”¯`,
                'success'
            );

            console.log(`åˆ†æ”¯ç»Ÿè®¡: æ€»è®¡ ${totalBranchesCount} ä¸ªåˆ†æ”¯, å¹³å‡ ${avgBranches} ä¸ª/é¡¹ç›®, å…±åŒåˆ†æ”¯ ${commonBranchArray.length} ä¸ª`);

        } catch (error) {
            console.error('åŠ è½½åˆ†æ”¯å¤±è´¥:', error);
            showToast('åŠ è½½åˆ†æ”¯å¤±è´¥: ' + error.message, 'error');
            sourceBranch.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            targetBranch.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        }
    }

    function clearBranches() {
        document.getElementById('sourceBranch').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®</option>';
        document.getElementById('targetBranch').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®</option>';
        document.getElementById('commonBranches').textContent = '0';
    }

    // ====== æŒ‡æ´¾äººå‘˜ç®¡ç† ======
    async function loadAssignees() {
        if (selectedProjects.size === 0) return;

        const assigneeSelect = document.getElementById('assigneeSelect');
        assigneeSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

        try {
            // è·å–ç¬¬ä¸€ä¸ªé¡¹ç›®çš„æˆå‘˜ä½œä¸ºé»˜è®¤é€‰é¡¹
            const firstProjectId = Array.from(selectedProjects)[0];
            const members = await apiRequest(`/projects/${firstProjectId}/members/all`);

            const options = ['<option value="">æ— </option>'];
            let defaultAssigneeId = null;

            members.forEach(member => {
                options.push(`<option value="${member.id}">${member.name} (@${member.username})</option>`);
                if (member.name === 'é‚¢æŸ³') {
                    defaultAssigneeId = member.id;
                }
            });

            assigneeSelect.innerHTML = options.join('');

            if (defaultAssigneeId) {
                assigneeSelect.value = defaultAssigneeId;
            }

            // åˆ·æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
            refreshCustomSelect('assigneeSelect');
        } catch (error) {
            console.error('åŠ è½½æŒ‡æ´¾äººå‘˜å¤±è´¥:', error);
            assigneeSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        }
    }

    // ====== æäº¤é¢„è§ˆ ======
    async function previewCommits() {
        const sourceBranch = document.getElementById('sourceBranch').value;
        const targetBranch = document.getElementById('targetBranch').value;

        if (!sourceBranch || !targetBranch) {
            showToast('è¯·å…ˆé€‰æ‹©æºåˆ†æ”¯å’Œç›®æ ‡åˆ†æ”¯', 'warning');
            return;
        }

        const commitsTable = document.getElementById('commitsTable');
        const tableBody = document.getElementById('commitsTableBody');

        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;"><div class="loading"></div> æ­£åœ¨åŠ è½½æäº¤ä¿¡æ¯...</td></tr>';

        try {
            const commitPromises = Array.from(selectedProjects).map(async projectId => {
                const project = allProjects.find(p => p.id === projectId);
                try {
                    const comparison = await apiRequest(`/projects/${projectId}/repository/compare?from=${targetBranch}&to=${sourceBranch}`);
                    return { project, commits: comparison.commits || [] };
                } catch (error) {
                    console.error(`è·å–é¡¹ç›® ${project.name} çš„æäº¤å¤±è´¥:`, error);
                    return { project, commits: [], error: error.message };
                }
            });

            const results = await Promise.all(commitPromises);

            let totalCommits = 0;
            const rows = [];

            results.forEach(({ project, commits, error }) => {
                if (error) {
                    rows.push(`
                        <tr>
                            <td>${project.name}</td>
                            <td colspan="4" style="color: #dc3545;">âŒ é”™è¯¯: ${error}</td>
                        </tr>
                    `);
                } else if (commits.length === 0) {
                    rows.push(`
                        <tr>
                            <td>${project.name}</td>
                            <td colspan="4" style="text-align: center; color: #999;">ğŸ“­ æ— å·®å¼‚æäº¤</td>
                        </tr>
                    `);
                } else {
                    commits.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    commits.forEach(commit => {
                        const commitUrl = `${gitlabConfig.server}/${project.path_with_namespace}/commit/${commit.id}`;
                        rows.push(`
                            <tr>
                                <td>${project.name}</td>
                                <td><a href="${commitUrl}" target="_blank" class="commit-link">${commit.short_id}</a></td>
                                <td>${commit.title}</td>
                                <td>${commit.author_name}</td>
                                <td>${new Date(commit.created_at).toLocaleString()}</td>
                            </tr>
                        `);
                        totalCommits++;
                    });
                }
            });

            tableBody.innerHTML = rows.join('');
            document.getElementById('totalCommits').textContent = totalCommits;
            showToast(`æ‰¾åˆ° ${totalCommits} ä¸ªæäº¤å·®å¼‚`);
        } catch (error) {
            console.error('é¢„è§ˆæäº¤å¤±è´¥:', error);
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #dc3545;">âŒ åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
            showToast('é¢„è§ˆæäº¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    // ====== æ‰¹é‡åˆ›å»ºMR ======
    async function createBatchMR() {
        const sourceBranch = document.getElementById('sourceBranch').value;
        const targetBranch = document.getElementById('targetBranch').value;
        const titleTemplate = document.getElementById('titleTemplate').value;
        const description = document.getElementById('descriptionTemplate').value;

        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ AI ç”Ÿæˆçš„ä¿¡æ¯
        const useAiGenerated = aiGeneratedMRInfo.size > 0;

        // æ ¹æ®æ¨¡å¼é€‰æ‹©æŒ‡æ´¾äººå‘˜
        const assigneeId = useAiGenerated
            ? document.getElementById('assigneeSelectAi').value
            : document.getElementById('assigneeSelect').value;

        if (!sourceBranch || !targetBranch) {
            showToast('è¯·å…ˆé€‰æ‹©æºåˆ†æ”¯å’Œç›®æ ‡åˆ†æ”¯', 'warning');
            return;
        }

        if (useAiGenerated) {
            showToast('ğŸ¤– å°†ä½¿ç”¨ AI ç”Ÿæˆçš„ MR ä¿¡æ¯', 'info');
        }

        //if (!confirm(`ç¡®å®šè¦ä¸º ${selectedProjects.size} ä¸ªé¡¹ç›®åˆ›å»ºåˆå¹¶è¯·æ±‚å—ï¼Ÿ\n\næºåˆ†æ”¯: ${sourceBranch}\nç›®æ ‡åˆ†æ”¯: ${targetBranch}`)) {
        //    return;
        //}

        // æ˜¾ç¤ºè¿›åº¦
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultsTable = document.getElementById('resultsTable');
        const resultsTableBody = document.getElementById('resultsTableBody');

        progressContainer.style.display = 'block';
        resultsTable.classList.remove('hidden');
        resultsTableBody.innerHTML = '';

        const projectIds = Array.from(selectedProjects);
        let completed = 0;
        let successCount = 0;
        let errorCount = 0;

        for (const projectId of projectIds) {
            const project = allProjects.find(p => p.id === projectId);

            // ä¼˜å…ˆä½¿ç”¨ AI ç”Ÿæˆçš„ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ¨¡æ¿
            let title, desc;
            if (useAiGenerated && aiGeneratedMRInfo.has(projectId)) {
                const aiInfo = aiGeneratedMRInfo.get(projectId);
                title = aiInfo.title;
                desc = aiInfo.description;
            } else {
                title = titleTemplate
                    .replace('{source}', sourceBranch)
                    .replace('{target}', targetBranch)
                    .replace('{project}', project.name)
                    .replace('{date}', new Date().toISOString().split('T')[0]);

                desc = description
                    .replace('{source}', sourceBranch)
                    .replace('{target}', targetBranch)
                    .replace('{project}', project.name)
                    .replace('{date}', new Date().toISOString().split('T')[0]);
            }

            // æ›´æ–°è¿›åº¦
            progressText.textContent = `æ­£åœ¨å¤„ç†: ${project.name} (${completed + 1}/${projectIds.length})`;
            progressFill.style.width = `${(completed / projectIds.length) * 100}%`;

            try {
                const mrData = {
                    source_branch: sourceBranch,
                    target_branch: targetBranch,
                    title: title,
                    description: desc || undefined,
                    assignee_id: assigneeId || undefined
                };

                const result = await apiRequest(`/projects/${projectId}/merge_requests`, {
                    method: 'POST',
                    body: JSON.stringify(mrData)
                });

                const mrUrl = `${gitlabConfig.server}/${project.path_with_namespace}/merge_requests/${result.iid}`;

                resultsTableBody.innerHTML += `
                    <tr>
                        <td>${project.name}</td>
                        <td><span class="status-success">âœ… æˆåŠŸ</span></td>
                        <td>#${result.iid}</td>
                        <td><a href="${mrUrl}" target="_blank">ğŸ”— æŸ¥çœ‹MR</a></td>
                        <td>-</td>
                    </tr>
                `;
                successCount++;
            } catch (error) {
                console.error(`åˆ›å»ºMRå¤±è´¥ (${project.name}):`, error);
                resultsTableBody.innerHTML += `
                    <tr>
                        <td>${project.name}</td>
                        <td><span class="status-error">âŒ å¤±è´¥</span></td>
                        <td>-</td>
                        <td>-</td>
                        <td>${error.message}</td>
                    </tr>
                `;
                errorCount++;
            }

            completed++;
            progressFill.style.width = `${(completed / projectIds.length) * 100}%`;

            // æ·»åŠ å»¶è¿Ÿé¿å…APIé™åˆ¶
            if (completed < projectIds.length) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        progressText.textContent = `å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±è´¥: ${errorCount}`;
        showToast(`æ‰¹é‡åˆ›å»ºå®Œæˆï¼æˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${errorCount} ä¸ª`, successCount > 0 ? 'success' : 'error');
    }



    // ====== å¿«é€Ÿé€‰æ‹©åˆ†æ”¯ ======
    function quickSelectBranch(source, target) {
        const sourceBranchSelect = document.getElementById('sourceBranch');
        const targetBranchSelect = document.getElementById('targetBranch');

        // æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        const sourceExists = Array.from(sourceBranchSelect.options).some(opt => opt.value === source);
        const targetExists = Array.from(targetBranchSelect.options).some(opt => opt.value === target);

        if (!sourceExists || !targetExists) {
            const missing = [];
            if (!sourceExists) missing.push(source);
            if (!targetExists) missing.push(target);
            showToast(`åˆ†æ”¯ä¸å­˜åœ¨: ${missing.join(', ')}`, 'warning');
            return;
        }

        // è®¾ç½®åˆ†æ”¯
        sourceBranchSelect.value = source;
        targetBranchSelect.value = target;

        // æ‰‹åŠ¨è§¦å‘ change äº‹ä»¶ï¼Œè®©è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†ç›‘å¬åˆ°å˜åŒ–
        const sourceChangeEvent = new Event('change', { bubbles: true });
        const targetChangeEvent = new Event('change', { bubbles: true });
        sourceBranchSelect.dispatchEvent(sourceChangeEvent);
        targetBranchSelect.dispatchEvent(targetChangeEvent);

        // åˆ·æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ˜¾ç¤ºï¼ˆåŒé‡ä¿é™©ï¼‰
        refreshCustomSelect('sourceBranch');
        refreshCustomSelect('targetBranch');

        showToast(`å·²é€‰æ‹©: ${source} â†’ ${target}`, 'success');
    }

    // ====== æœç´¢åŠŸèƒ½ ======
    let searchTimeout;
    document.getElementById('projectSearch').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = this.value.toLowerCase().trim();
            const filtered = getFilteredProjects();
            renderProjects(filtered);

            // ä¿å­˜æœç´¢å†å²
            if (query && query.length > 2) {
                searchHistory = searchHistory.filter(item => item !== query);
                searchHistory.unshift(query);
                searchHistory = searchHistory.slice(0, 10); // åªä¿ç•™æœ€è¿‘10ä¸ª
                localStorage.setItem('search-history', JSON.stringify(searchHistory));
            }
        }, 300);
    });

    // ====== åˆ†æ”¯é€‰æ‹©ç›‘å¬ ======
    document.getElementById('sourceBranch').addEventListener('change', function() {
        updateTitleTemplate();
        handleBranchChange();
    });

    document.getElementById('targetBranch').addEventListener('change', function() {
        updateTitleTemplate();
        handleBranchChange();
    });

    function updateTitleTemplate() {
        const sourceBranch = document.getElementById('sourceBranch').value;
        const targetBranch = document.getElementById('targetBranch').value;
        const template = document.getElementById('titleTemplate');

        if (sourceBranch && targetBranch) {
            // åªæœ‰åœ¨è¾“å…¥æ¡†ä¸ºç©ºæˆ–è€…æ˜¯é»˜è®¤æ¨¡æ¿æ ¼å¼æ—¶æ‰è‡ªåŠ¨å¡«å……
            if (!template.value || template.value === '{source} â†’ {target}' || template.value.includes(' â†’ ') || template.value.includes(' -> ')) {
                template.value = `${sourceBranch} â†’ ${targetBranch}`;
            }
        }
    }

    function handleBranchChange() {
        const sourceBranch = document.getElementById('sourceBranch').value;
        const targetBranch = document.getElementById('targetBranch').value;

        // å¦‚æœæºåˆ†æ”¯å’Œç›®æ ‡åˆ†æ”¯éƒ½å·²é€‰æ‹©ï¼Œè‡ªåŠ¨é¢„è§ˆæäº¤å·®å¼‚
        if (sourceBranch && targetBranch && selectedProjects.size > 0) {
            // å»¶è¿Ÿä¸€ä¸‹ï¼Œè®©UIæ›´æ–°å®Œæˆ
            setTimeout(() => {
                previewCommits();
            }, 100);
        } else {
            // é‡ç½®ç»Ÿè®¡æ•°æ®
            document.getElementById('totalCommits').textContent = '0';
        }
    }

    function clearCommitsPreview() {
        const commitsTable = document.getElementById('commitsTable');
        const tableBody = document.getElementById('commitsTableBody');

        commitsTable.style.display = 'none';
        tableBody.innerHTML = '';
        document.getElementById('totalCommits').textContent = '0';

        showToast('æäº¤é¢„è§ˆå·²å…³é—­', 'success');
    }

    // ====== å¿«æ·é”®æ”¯æŒ ======
    let currentProjectIndex = -1;

    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'Enter':
                    e.preventDefault();
                    if (!document.getElementById('createBtn').disabled) {
                        createBatchMR();
                    }
                    break;
                case 'a':
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        selectAll();
                    }
                    break;

            }
        } else if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            switch(e.key) {
                case 'Escape':
                    document.getElementById('projectSearch').blur();
                    currentProjectIndex = -1;
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    navigateProjects(-1);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    navigateProjects(1);
                    break;
                case 'Enter':
                    if (currentProjectIndex >= 0) {
                        const projects = getFilteredProjects();
                        if (projects[currentProjectIndex]) {
                            toggleProject(projects[currentProjectIndex].id);
                        }
                    }
                    break;
            }
        }
    });

    function navigateProjects(direction) {
        const projects = getFilteredProjects();
        const items = document.querySelectorAll('.project-item');

        if (items.length === 0) return;

        // ç§»é™¤å½“å‰é«˜äº®
        if (currentProjectIndex >= 0 && currentProjectIndex < items.length) {
            items[currentProjectIndex].style.backgroundColor = '';
        }

        // æ›´æ–°ç´¢å¼•
        currentProjectIndex += direction;
        if (currentProjectIndex < 0) currentProjectIndex = items.length - 1;
        if (currentProjectIndex >= items.length) currentProjectIndex = 0;

        // é«˜äº®æ–°çš„é¡¹ç›®
        items[currentProjectIndex].style.backgroundColor = '#e6f7ff';
        items[currentProjectIndex].scrollIntoView({ block: 'nearest' });
    }

    // ====== è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†ç»„ä»¶ç±» ======
    class CustomSelect {
        constructor(selectElement, options = {}) {
            this.selectElement = selectElement;
            this.options = options;
            this.selectedValue = selectElement.value || '';
            this.isOpen = false;
            this.init();
        }

        init() {
            // éšè—åŸç”Ÿselect
            this.selectElement.style.display = 'none';

            // åˆ›å»ºè‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
            this.wrapper = document.createElement('div');
            this.wrapper.className = 'custom-select-wrapper';

            // åˆ›å»ºè§¦å‘å™¨
            this.trigger = document.createElement('div');
            this.trigger.className = 'custom-select-trigger';
            this.trigger.innerHTML = `
                <span class="custom-select-value ${!this.selectedValue ? 'placeholder' : ''}">
                    ${this.getSelectedText()}
                </span>
                <svg class="custom-select-arrow" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            `;

            // åˆ›å»ºä¸‹æ‹‰é¢æ¿
            this.dropdown = document.createElement('div');
            this.dropdown.className = 'custom-select-dropdown';
            this.renderOptions();

            // ç»„è£…
            this.wrapper.appendChild(this.trigger);
            this.wrapper.appendChild(this.dropdown);
            this.selectElement.parentNode.insertBefore(this.wrapper, this.selectElement);

            // ç»‘å®šäº‹ä»¶
            this.bindEvents();
        }

        getSelectedText() {
            if (!this.selectedValue) {
                return this.options.placeholder || 'è¯·é€‰æ‹©';
            }
            const option = Array.from(this.selectElement.options).find(opt => opt.value === this.selectedValue);
            return option ? option.text : this.options.placeholder || 'è¯·é€‰æ‹©';
        }

        renderOptions() {
            const options = Array.from(this.selectElement.options);
            let html = '';

            options.forEach(option => {
                const isSelected = option.value === this.selectedValue;
                html += `
                    <div class="custom-select-option ${isSelected ? 'selected' : ''}" data-value="${option.value}">
                        ${option.text}
                    </div>
                `;
            });

            if (options.length === 0) {
                html = '<div class="custom-select-empty">æš‚æ— é€‰é¡¹</div>';
            }

            this.dropdown.innerHTML = html;
        }

        bindEvents() {
            // ç‚¹å‡»è§¦å‘å™¨
            this.trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggle();
            });

            // ç‚¹å‡»é€‰é¡¹
            this.dropdown.addEventListener('click', (e) => {
                const option = e.target.closest('.custom-select-option');
                if (option) {
                    const value = option.dataset.value;
                    this.select(value);
                }
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            document.addEventListener('click', (e) => {
                if (!this.wrapper.contains(e.target)) {
                    this.close();
                }
            });

            // ç›‘å¬åŸç”Ÿselectå˜åŒ–ï¼ˆå¤–éƒ¨æ›´æ–°ï¼‰
            this.selectElement.addEventListener('change', () => {
                this.selectedValue = this.selectElement.value;
                this.updateDisplay();
            });

            // ç›‘å¬çª—å£æ»šåŠ¨å’Œresizeï¼Œæ›´æ–°ä¸‹æ‹‰é¢æ¿ä½ç½®
            this.updatePositionHandler = () => {
                if (this.isOpen) {
                    const rect = this.trigger.getBoundingClientRect();
                    this.dropdown.style.top = `${rect.bottom + 8}px`;
                    this.dropdown.style.left = `${rect.left}px`;
                    this.dropdown.style.width = `${rect.width}px`;
                }
            };

            window.addEventListener('scroll', this.updatePositionHandler, true);
            window.addEventListener('resize', this.updatePositionHandler);
        }

        toggle() {
            if (this.isOpen) {
                this.close();
            } else {
                this.open();
            }
        }

        open() {
            this.isOpen = true;
            this.trigger.classList.add('active');

            // è®¡ç®—ä¸‹æ‹‰é¢æ¿çš„ä½ç½®ï¼ˆä½¿ç”¨fixedå®šä½ï¼‰
            const rect = this.trigger.getBoundingClientRect();
            this.dropdown.style.top = `${rect.bottom + 8}px`;
            this.dropdown.style.left = `${rect.left}px`;
            this.dropdown.style.width = `${rect.width}px`;

            this.dropdown.classList.add('show');
        }

        close() {
            this.isOpen = false;
            this.trigger.classList.remove('active');
            this.dropdown.classList.remove('show');
        }

        select(value) {
            this.selectedValue = value;
            this.selectElement.value = value;

            // è§¦å‘åŸç”Ÿchangeäº‹ä»¶
            const event = new Event('change', { bubbles: true });
            this.selectElement.dispatchEvent(event);

            this.updateDisplay();
            this.close();
        }

        updateDisplay() {
            // æ›´æ–°è§¦å‘å™¨æ–‡æœ¬
            const valueSpan = this.trigger.querySelector('.custom-select-value');
            valueSpan.textContent = this.getSelectedText();
            valueSpan.className = `custom-select-value ${!this.selectedValue ? 'placeholder' : ''}`;

            // æ›´æ–°é€‰é¡¹çŠ¶æ€
            this.renderOptions();
        }

        // æ›´æ–°é€‰é¡¹åˆ—è¡¨ï¼ˆå½“åŸç”Ÿselectçš„optionsæ”¹å˜æ—¶è°ƒç”¨ï¼‰
        refresh() {
            this.renderOptions();
            this.updateDisplay();
        }

        // é”€æ¯
        destroy() {
            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            if (this.updatePositionHandler) {
                window.removeEventListener('scroll', this.updatePositionHandler, true);
                window.removeEventListener('resize', this.updatePositionHandler);
            }

            this.wrapper.remove();
            this.selectElement.style.display = '';
        }
    }

    // å…¨å±€å­˜å‚¨è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†å®ä¾‹
    const customSelects = new Map();

    // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
    function initCustomSelect(selectId, options = {}) {
        const selectElement = document.getElementById(selectId);
        if (!selectElement) {
            console.error(`Select element with id "${selectId}" not found`);
            return null;
        }

        // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œå…ˆé”€æ¯
        if (customSelects.has(selectId)) {
            customSelects.get(selectId).destroy();
        }

        // åˆ›å»ºæ–°å®ä¾‹
        const customSelect = new CustomSelect(selectElement, options);
        customSelects.set(selectId, customSelect);
        return customSelect;
    }

    // åˆ·æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†ï¼ˆå½“é€‰é¡¹æ”¹å˜æ—¶è°ƒç”¨ï¼‰
    function refreshCustomSelect(selectId) {
        const customSelect = customSelects.get(selectId);
        if (customSelect) {
            customSelect.refresh();
        }
    }

    // ====== åˆå§‹åŒ– ======
    document.addEventListener('DOMContentLoaded', function() {
        loadConfig();
        loadProjects();

        // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        updateButtonStates();

        // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
        setTimeout(() => {
            initCustomSelect('sourceBranch', { placeholder: 'é€‰æ‹©æºåˆ†æ”¯' });
            initCustomSelect('targetBranch', { placeholder: 'é€‰æ‹©ç›®æ ‡åˆ†æ”¯' });
            initCustomSelect('assigneeSelect', { placeholder: 'æ— ' });

            // é¡µé¢åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºbodyï¼ˆé˜²æ­¢é—ªçƒï¼‰
            document.body.classList.add('loaded');
        }, 100);

        // æ·»åŠ é…ç½®è¾“å…¥æ¡†çš„å®æ—¶ç›‘å¬
        const serverInput = document.getElementById('gitlabServer');
        const tokenInput = document.getElementById('gitlabToken');

        // è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶è‡ªåŠ¨åŒæ­¥é…ç½®ï¼ˆå®æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€ç‚¹ä¿å­˜ï¼‰
        serverInput.addEventListener('blur', syncConfigFromInputs);
        tokenInput.addEventListener('blur', syncConfigFromInputs);

        // è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶ä¹ŸåŒæ­¥ï¼ˆæ›´åŠ å®æ—¶ï¼‰
        serverInput.addEventListener('input', syncConfigFromInputs);
        tokenInput.addEventListener('input', syncConfigFromInputs);

        // ç›‘å¬é¡¹ç›®é€‰æ‹©å˜åŒ–ä»¥åŠ è½½æŒ‡æ´¾äººå‘˜
        let lastSelectedSize = 0;
        setInterval(() => {
            if (selectedProjects.size > 0 && selectedProjects.size !== lastSelectedSize) {
                loadAssignees();
                lastSelectedSize = selectedProjects.size;
            }
        }, 1000);


    });
</script>
</body>
</html>